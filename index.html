<!DOCTYPE html>

<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kockari Pobedjuju Liga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to: { translateX(100%); opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to: { opacity: 0; } }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px rgba(250, 204, 21, 0.4), 0 0 3px rgba(250, 204, 21, 0.6); }
            50% { box-shadow: 0 0 20px rgba(250, 204, 21, 0.8), 0 0 8px rgba(250, 204, 21, 1); }
        }

        /* --- Loader Styles --- */
        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        .loader-content {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .loader-logo {
            width: 150px;
            height: auto;
        }
        .loader-spinner {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 5px solid transparent;
            border-top-color: #fde047; /* Zlatna boja kao naslov */
            animation: spin 1.2s linear infinite;
        }
        .loader-fade-out {
            opacity: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            background-image: radial-gradient(ellipse at 50% 20%, rgba(127, 29, 29, 0.45) 0%, rgba(0,0,0,0) 70%), linear-gradient(170deg, #1a0303 0%, #000000 60%);
            color: #f4f4f5;
            line-height: 1.5;
            position: relative;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- Responsive View Switching --- */
        .desktop-view { display: none; } 
        .mobile-view { display: flex; flex-direction: column; }

        @media (min-width: 1024px) {
            .desktop-view { 
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                min-height: 100vh;
                padding: 24px 16px;
            }
            .mobile-view { display: none; }
        }
        
        @media (max-width: 1023px) {
            body { padding: 0; padding-bottom: 60px; }
            #userHistoryModal .modal-content {
                overflow-x: hidden;
            }
        }

        .centered-content-wrapper { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 1600px; margin: 0 auto; flex-grow: 1; }
        .page-layout-container { display: flex; flex-direction: column; width: 100%; gap: 24px; }
        @media (min-width: 1024px) { .page-layout-container { flex-direction: row; justify-content: center; align-items: flex-start; } }
        .main-content-wrapper { display: flex; flex-direction: column; gap: 24px; width: 100%; max-width: 1280px; position: relative; z-index: 0; }
        @media (min-width: 1024px) { .main-content-wrapper { flex-direction: row; align-items: flex-start; } }
        
        .card { background-color: #27272a; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border: 1px solid #3f3f46; padding: 24px; background-image: url('https://i.imgur.com/IfYhIlf.jpeg'); background-repeat: repeat; background-size: cover; background-position: center; }
        
        .table-container { 
            height: calc(20 * 36px + 40px);
            overflow-y: auto; 
            position: relative; 
            background-color: #2d3748; 
            border-radius: 12px;
            border: 1px solid #4a5568;
        }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 4px 12px; text-align: left; border-bottom: 1px solid #4a5568; white-space: nowrap; height: 36px; }
        th { 
            background-image: linear-gradient(to bottom, #4a5568, #2d3748);
            color: #e2e8f0; 
            font-size: 10px; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            height: 40px; 
            border-right: 1px solid #3f3f46;
        }
        th:last-child { 
            border-top-right-radius: 12px;
            border-right: none;
        }
        th:first-child { border-top-left-radius: 12px; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: rgba(74, 85, 104, 0.5); }
        tbody tr.highlighted { background-color: rgba(59, 130, 246, 0.2); }
        td { color: #d4d4d8; font-size: 14px; }
        .country-abbr { font-size: 0.75rem; color: #a1a1aa; margin-left: 6px; font-weight: 500; }
        
        tr.rank-1 { background: linear-gradient(90deg, rgba(255, 215, 0, 0.25), rgba(255, 215, 0, 0.05)); }
        tr.rank-2 { background: linear-gradient(90deg, rgba(192, 192, 192, 0.25), rgba(192, 192, 192, 0.05)); }
        tr.rank-3 { background: linear-gradient(90deg, rgba(205, 127, 50, 0.25), rgba(205, 127, 50, 0.05)); }
        tr.rank-1:hover, tr.rank-2:hover, tr.rank-3:hover { background-color: rgba(74, 85, 104, 0.7); }

        tr.logged-in-user {
            background-color: rgba(59, 130, 246, 0.2) !important;
            box-shadow: inset 0 0 8px rgba(59, 130, 246, 0.4);
            border-left: 2px solid #3b82f6;
            border-right: 2px solid #3b82f6;
        }
        tr.logged-in-user:hover {
            background-color: rgba(59, 130, 246, 0.3) !important;
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 50; transition: opacity 0.3s ease-in-out, visibility 0s 0.3s; visibility: hidden; opacity: 0; }
        .modal-overlay.show { visibility: visible; opacity: 1; transition: opacity 0.3s ease-in-out; }
        .modal-content { background-color: #27272a; padding: 32px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.08); position: relative; width: 90%; max-width: 672px; max-height: 90vh; overflow-y: auto; transform: translateY(-32px); transition: transform 0.3s ease-out; border: 1px solid #3f3f46; }
        .modal-overlay.show .modal-content { transform: translateY(0); }
        .modal-close-button { position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: #a1a1aa; transition: color 0.2s ease-in-out; z-index: 60; }
        .modal-close-button:hover { color: #fb7185; }
        .modal-back-button { position: absolute; top: 16px; left: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: #a1a1aa; transition: color 0.2s ease-in-out; z-index: 60; }
        .modal-back-button:hover { color: #f4f4f5; }
        
        .auth-sidebar { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; z-index: 20; width: 100%; max-width: 500px; margin: 0 auto; }
        @media (min-width: 1024px) { .auth-sidebar { width: 250px; flex-shrink: 0; margin: 0; } }
        
        .custom-button { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-weight: 700; cursor: pointer; transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; width: 100%; border: none; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .custom-button:hover { transform: translateY(-1px); }
        
        .gradient-button {
            background: linear-gradient(to right, #fde047, #f97316);
            color: #1c1917;
            font-weight: 800;
        }
        .gradient-button:hover {
            background: linear-gradient(to right, #facc15, #ea580c);
        }

        .input-field, .select-field { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #52525b; background-color: #3f3f46; color: white; font-size: 1rem; appearance: none; }
        .input-field::placeholder, .select-field:invalid { color: #a1a1aa; }
        .select-field { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a1a1aa' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        
        .main-title-container { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .main-title-text { font-size: 3rem; font-weight: 800; display: flex; align-items: center; justify-content: center; line-height: 1; letter-spacing: -0.02em; flex-direction: row; flex-wrap: wrap; gap: 0.5rem; }
        .gradient-title { background: linear-gradient(to right, #fde047, #f97316); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; color: transparent; padding: 0 0.5rem; }
        .main-title-text img { height: 5.5rem; vertical-align: middle; object-fit: contain; }
        .league-title-large { font-size: 2.5rem; font-weight: 800; color: #FFFFFF; line-height: 1; margin-top: -0.8rem; letter-spacing: -0.02em; }
        .profit-positive { color: #34d399; }
        .profit-negative { color: #fb7185; }
        .profit-neutral { color: #d4d4d8; }
        
        #toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Definicije animacija ostaju iste */
@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes fadeOut { from { opacity: 1; } to: { opacity: 0; } }

/* Novi stil za toast notifikacije */
.toast {
    display: flex;
    align-items: center; /* Vertikalno centriranje ikonice i teksta */
    position: relative;
    padding: 12px 16px; /* Malo izmenjen padding */
    padding-right: 40px;
    width: 330px;
    background-color: #1f2937; /* Tamnija pozadina */
    border-radius: 8px;
    border: 1px solid #4b5563;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    animation: slideInRight 0.3s cubic-bezier(0.21, 1.02, 0.73, 1) forwards;
    overflow: hidden; /* Za progress bar */
}

.toast.closing {
    animation: slideOutRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}

.toast-icon {
    flex-shrink: 0;
    display: flex; /* Za centriranje ikonice */
    justify-content: center;
    align-items: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    margin-right: 12px;
}

.toast-icon i {
    width: 18px; /* Malo manja ikonica */
    height: 18px;
}

/* Definicije boja za različite tipove notifikacija */
.toast-success .toast-icon { background-color: rgba(16, 185, 129, 0.2); color: #34d399; }
.toast-error .toast-icon { background-color: rgba(239, 68, 68, 0.2); color: #fb7185; }
.toast-info .toast-icon { background-color: rgba(59, 130, 246, 0.2); color: #60a5fa; }

.toast-content {
    flex-grow: 1;
}

.toast-title {
    font-weight: 700;
    font-size: 0.9rem;
    color: #f9fafb; /* Svetliji naslov */
    margin: 0;
}

.toast-message {
    font-size: 0.85rem;
    color: #d1d5db; /* Svetlija poruka */
    line-height: 1.4;
    margin-top: 2px;
}

.toast-close-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: transparent;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: color 0.2s, background-color 0.2s;
}

.toast-close-btn:hover {
    color: #f9fafb;
    background-color: rgba(255, 255, 255, 0.1);
}

/* Progress bar */
.toast-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    width: 100%;
    animation: progress-bar 2s linear forwards;
}
.toast-success .toast-progress { background-color: #34d399; }
.toast-error .toast-progress { background-color: #fb7185; }
.toast-info .toast-progress { background-color: #60a5fa; }

@keyframes progress-bar {
    from { width: 100%; }
    to { width: 0%; }
}
        .outcome-square { display: inline-flex; justify-content: center; align-items: center; width: 24px; height: 24px; font-weight: 700; border-radius: 6px; margin: 2px; font-size: 12px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); color: white; cursor: pointer; position: relative; }
        .outcome-D { background-color: #10b981; }
        .outcome-G { background-color: #ef4444; }
        .outcome-P { background-color: #71717a; }
        .outcome-A { background-color: #3b82f6; }

        .profile-card { background-color: #27272a; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border: 1px solid #3f3f46; padding: 16px; background-image: url('https://i.imgur.com/IfYhIlf.jpeg'); background-repeat: repeat; background-size: cover; background-position: center; width: 100%; }
        
        #addTicketModal .modal-content { 
            background-image: url('https://i.imgur.com/JlTXDe9.png');
            background-size: cover; 
            background-position: center;
            border: 1px solid #f59e0b;
        }
        #addTicketModal .input-field::placeholder { 
            font-size: 13px;
            font-style: italic; 
            color: #a1a1aa; 
        }
        .bet-slip-modal .modal-content { background: #0f172a; color: #f1f5f9; border-radius: 12px; border: 1px solid #334155; max-width: 450px; }
        .bet-slip-modal .modal-close-button { color: #a1a1aa; }
        .bet-slip-modal .modal-close-button:hover { color: #fb7185; }
        .bet-slip-header { background: linear-gradient(to right, #f59e0b, #ef4444); color: white; padding: 12px; border-top-left-radius: 11px; border-top-right-radius: 11px; text-align: center; font-weight: 800; font-size: 1.25rem; letter-spacing: 1px; text-transform: uppercase; }
        .bet-slip-modal .input-field { background-color: #1e293b; border: 1px solid #475569; color: white; transition: all 0.2s ease; }
        .bet-slip-modal .input-field:focus { outline: none; border-color: #f59e0b; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3); }
        
        #myProfileModal .modal-content {
            background-image: url('https://i.imgur.com/IfYhIlf.jpeg');
            background-size: cover;
            background-position: center;
            border: 1px solid #64748b;
        }
        .profile-modal-content { background: linear-gradient(to bottom right, #1e293b, #0f172a); border: 1px solid #475569; }
        .profile-pic-container { position: relative; width: 128px; height: 128px; border-radius: 50%; margin: 0 auto; background-color: #52525b; display: flex; justify-content: center; align-items: center; overflow: visible; border: 4px solid #a1a1aa; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .profile-pic-container img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        
        #profileModalUsername { font-size: 1.75rem; font-weight: 700; }
        .profile-option-button { display: flex; align-items: center; gap: 12px; padding: 14px; background-color: rgba(51, 65, 85, 0.5); border: 1px solid #475569; border-radius: 8px; color: white; font-weight: 500; cursor: pointer; transition: all 0.2s ease-in-out; width: 100%; text-align: left; font-size: 1rem; }
        .profile-option-button:hover { background-color: #334155; border-color: #64748b; transform: translateY(-1px); }
        .profile-option-button i { width: 20px; height: 20px; color: #94a3b8; }.sponsor-card-hover-effect {
            transition: box-shadow 0.3s ease-in-out, transform 0.2s ease-in-out;
        }
        .sponsor-card-hover-effect:hover {
            transform: translateY(-4px);
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.5);
        }

        .rulesLink { display: flex; align-items: center; gap: 8px; font-size: 1rem; font-weight: 600; color: #d4d4d8; padding: 10px 16px; border-radius: 8px; background-color: #27272a; border: 1px solid #3f3f46; transition: all 0.2s ease-in-out; width: 100%; justify-content: center; cursor: pointer; }
        .rulesLink:hover { background-color: #3f3f46; color: white; border-color: #52525b; }
        
        #centralTicketPopover, #dailyWinPopover {
            background-color: transparent;
            border: none;
            padding: 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 120;
            width: 380px;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
            border-radius: 8px;
            position: absolute;
            display: none;
        }
        @media (min-width: 1024px) {
    #centralTicketPopover, #dailyWinPopover, #bestTicketPopover {
        width: 440px; /* Povećano za desktop */
    }
}
        #centralTicketPopover.show, #dailyWinPopover.show {
            display: block;
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-100%) translateY(-10px);
        }
        
        @media (max-width: 420px) {
            #centralTicketPopover {
                width: 95vw;
            }
        }
        
        @media (max-width: 1023px) {
            #centralTicketPopover {
                position: relative;
                transform: none;
                width: 100%;
                max-width: 100%;
                z-index: auto;
                pointer-events: auto;
                margin-bottom: 1rem;
                box-shadow: none;
                display: none;
                opacity: 1;
                visibility: visible;
            }

            #centralTicketPopover.show {
                display: block;
                transform: none;
            }
        }

        #bestTicketPopover {
            position: absolute;
            z-index: 150;
            width: 380px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0s 0.2s;
            border-radius: 8px;
            background-color: transparent;
            border: none;
            padding: 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: none; 
        }
        #bestTicketPopover.show {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.2s ease-in-out;
        }
        .popover-content-wrapper {
            transition: opacity 0.15s ease-in-out;
        }
        
        .leaderboard-card { position: -webkit-sticky; position: sticky; top: 24px; }
        .coin-icon { display: inline-block; width: 1.1em; height: 1.1em; vertical-align: -0.15em; }
        
        #rulesModal .modal-content, #userHistoryModal .modal-content, #myTicketsModal .modal-content, #achievementsModal .modal-content, #settingsModal .modal-content, #tabelaModal .modal-content, #statistikaLigeModal .modal-content, #confirmModal .modal-content, #confirmPasswordResetModal .modal-content, #resetPasswordModal .modal-content {
            background-image: url('https://i.imgur.com/IfYhIlf.jpeg');
            background-size: cover;
            background-position: center;
        }
        .content-overlay { background-color: rgba(30, 41, 59, 0.9); padding: 2rem; border-radius: 8px; position: relative; }
        
        .rules-container { background-color: rgba(24, 24, 27, 0.9); padding: 2rem 3rem; border-radius: 8px; color: #d4d4d8; }
        .rules-container h2 { font-size: 1.8rem; font-weight: 800; color: #f59e0b; text-align: center; margin-bottom: 1rem; }
        .rules-container h3 { font-size: 1.2rem; font-weight: 700; color: #e4e4e7; margin-top: 1.5rem; margin-bottom: 0.5rem; padding-bottom: 0.25rem; border-bottom: 1px solid #52525b; }
        .rules-container p, .rules-container li { font-size: 1rem; line-height: 1.6; }
        .rules-container ul { list-style-type: disc; padding-left: 20px; margin-top: 0.5rem; }
        .rules-container strong { color: #e4e4e7; font-weight: 600; }
        
        .date-group-header { background-color: #3f3f46; padding: 8px 12px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 12px; display: flex; justify-content: space-between; align-items: center; }
        .date-group-header:first-child { margin-top: 0; }
        .date-group-tickets { display: none; padding-left: 10px; margin-top: 8px; border-left: 2px solid #52525b; }

        #settingsModal .input-field:disabled { background-color: #27272a; cursor: not-allowed; opacity: 0.6; }
        #settingsModal .form-section { background-color: rgba(51, 65, 85, 0.5); border: 1px solid #475569; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        #settingsModal .form-section h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #475569; }
        #settingsModal .form-section label { display: block; font-size: 0.875rem; color: #a1a1aa; margin-bottom: 0.25rem; }
        #settingsModal .form-section .input-field { margin-bottom: 0.75rem; }
        
        #loggedInProfile > button:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(253, 224, 71, 0.3); }
        .password-container { position: relative; display: flex; align-items: center; }
        .password-container .input-field { padding-right: 2.5rem; }
        .password-toggle { position: absolute; right: 0.75rem; cursor: pointer; color: #a1a1aa; }

        #searchPopup {
            position: absolute;
            top: 50%;
            right: 100%;
            margin-right: 8px;
            transform: translateY(-50%);
            background-color: rgba(39, 39, 42, 0.9);
            backdrop-filter: blur(4px);
            border: 1px solid #52525b;
            border-radius: 8px;
            padding: 8px;
            z-index: 20;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        #searchPopup.show {
            display: block;
            opacity: 1;
        }
        #leaderboardSearch {
             background: transparent;
             border: none;
             outline: none;
             color: white;
             width: 180px;
        }
        #leaderboardSearch::placeholder {
            color: #a1a1aa;
        }

        #instagram-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        #instagram-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(236, 72, 153, 0.2);
        }
        
        /* --- INSTAGRAM SLIDER --- */
        .instagram-posts-container {
            background-color: #000;
        }
        .instagram-posts-container .instagram-post-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* Changed */
            align-items: center;
            justify-content: center;
        }
        .instagram-posts-container .instagram-post-wrapper.active {
            display: flex; /* Changed */
        }
        .instagram-media {
            margin: auto !important;
            max-width: 100% !important;
            min-width: 100% !important;
            width: 100% !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }
        .instagram-nav-btn {
            opacity: 0.5;
            transition: opacity 0.2s ease-in-out;
        }
        #instagram-card:hover .instagram-nav-btn {
            opacity: 1;
        }

        .eighteen-plus-circle {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #a1a1aa;
            color: #a1a1aa;
            font-weight: 700;
            font-size: 10px;
            flex-shrink: 0;
        }
        
        /* Novi stilovi za plasman u modalu */
        .rank-display-wrapper { display: inline-flex; align-items: center; font-weight: 700; font-size: 1.5rem; gap: 0.5rem; }
        .rank-display-wrapper.rank-1 { color: #facc15; text-shadow: 0 0 8px rgba(250, 204, 21, 0.7); }
        .rank-display-wrapper.rank-2 { color: #d4d4d8; text-shadow: 0 0 8px rgba(212, 212, 216, 0.7); }
        .rank-display-wrapper.rank-3 { color: #e97451; text-shadow: 0 0 8px rgba(233, 116, 81, 0.7); }
        .rank-display-wrapper.rank-other { color: #a1a1aa; }
        .rank-display-wrapper i { width: 1.2em; height: 1.2em; }
        .rank-display-wrapper.unranked { font-size: 1.1rem; color: #71717a; font-weight: 500;}

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 10px;
            border: 2px solid #1e293b;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #64748b;
        }
        
        #settingsModal .modal-close-button, #rulesModal .modal-close-button,
        #settingsModal .modal-back-button {
            position: -webkit-sticky;
            position: sticky;
            top: 16px;
            z-index: 61;
        }
        #settingsModal .modal-close-button, #rulesModal .modal-close-button {
            float: right;
        }
        #settingsModal .modal-back-button {
            float: left;
        }

        /* --- Mobile View Specific Styles --- */
        #mobile-header {
            background-image: url('https://i.imgur.com/IfYhIlf.jpeg');
            background-size: cover;
            background-position: center;
        }
        .mobile-profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background-color: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 100;
            width: 180px;
        }
        #mobile-header .league-title-mobile {
            display: block;
            padding-left: 0;
        }
        #mobile-header .gradient-title {
             padding-left: 0;
        }
        #achievementsWinStreak, #achievementsLossStreak {
            text-align: center;
            display: block;
        }
        
        #modalUserInfo > div, #modalPlayerStats > div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            padding: 4px 0;
        }
        
        #mobile-table-wrapper {
            overflow-x: auto;
        }
        
        .extended-col {
            display: table-cell;
        }

        #mobile-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            border-top: 1px solid #3f3f46;
            padding: 8px 16px;
            z-index: 30;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #a1a1aa;
        }
        
        @media (max-width: 767px) {
            .rules-container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            #rulesModal .modal-content {
                overflow-x: hidden;
            }
        }

        /* --- Season Selector Dropdown --- */
        .season-selector-container {
            position: relative;
            width: 220px;
            margin: 0 auto;
        }
        .season-selector-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 16px;
            border: 1px solid #52525b;
            background-color: #3f3f46;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        .season-selector-button:hover {
            background-color: #52525b;
            border-color: #71717a;
        }
        .season-selector-button.current-season {
            background-color: #facc15;
            color: #18181b;
            border-color: #fde047;
            animation: glow 2.5s infinite ease-in-out;
        }
        .season-selector-button .chevron {
            transition: transform 0.3s ease;
        }
        .season-selector-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            width: 100%;
            background-color: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 8px;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            display: none; /* Changed from visibility/opacity for simplicity */
        }
        .season-selector-dropdown.show {
            display: block;
        }
        .season-selector-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-weight: 500;
        }
        .season-selector-item:hover {
            background-color: #3f3f46;
        }
        .season-selector-item.selected {
            background-color: #a1a1aa;
            color: #18181b;
            font-weight: 700;
        }
        
        .achievement-label {
            font-size: 0.8rem;
            color: #a1a1aa;
            text-transform: uppercase;
        }
        .achievement-value {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .ticket-body-processing {
            filter: blur(1.2px);
            opacity: 0.8;
            transition: all 0.2s ease-in-out;
        }
        
        /* --- TROPHY STYLES --- */
        .trophy-icon {
            width: 58px;
            height: 58px;
            object-fit: contain;
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .trophy-icon:hover {
            transform: scale(1.1);
        }
        .trophy-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 70px;
        }
        .trophy-name-below {
            font-size: 10px;
            color: #d4d4d8;
            text-align: center;
            margin-top: 4px;
            font-weight: 500;
            line-height: 1.2;
            width: 100%;
        }
        .trophy-tooltip {
            visibility: hidden;
            width: 160px; /* Smanjeno sa 200px */
            background-color: #18181b;
            color: #d4d4d8;
            text-align: center;
            border-radius: 6px;
            padding: 6px; /* Smanjeno sa 8px */
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            margin-left: -80px; /* Polovina nove širine */
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #52525b;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            font-size: 0.75rem; /* Smanjeno sa 0.8rem */
            line-height: 1.4;
        }
        .trophy-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #52525b transparent transparent transparent;
        }
        .trophy-wrapper:hover .trophy-tooltip {
            visibility: visible;
            opacity: 1;
        }
        @keyframes glow-permanent {
    0%, 100% { filter: drop-shadow(0 0 5px rgba(209, 213, 219, 0.5)); }
    50% { filter: drop-shadow(0 0 10px rgba(243, 244, 246, 0.8)); }
}

@keyframes glow-king {
    0%, 100% {
        filter: drop-shadow(0 0 6px rgba(252, 211, 77, 0.9))
                drop-shadow(0 0 12px rgba(245, 158, 11, 0.7));
    }
    50% {
        filter: drop-shadow(0 0 12px rgba(252, 211, 77, 1))
                drop-shadow(0 0 24px rgba(245, 158, 11, 0.9));
    }
}

.trophy-permanent .trophy-icon {
    /* Osnovno sijanje za sve stalne trofeje */
    animation: glow-permanent 2.5s infinite ease-in-out;
}

.trophy-king .trophy-icon {
    /* Jače sijanje koje preuzima primat za Kralja */
    animation: glow-king 2s infinite ease-in-out;
}

        /* --- GIVEAWAY CARD STYLES --- */
        @keyframes slideImages {
            0%, 20% { transform: translateX(0%); }
            25%, 45% { transform: translateX(-25%); }
            50%, 70% { transform: translateX(-50%); }
            75%, 95% { transform: translateX(-75%); }
            100% { transform: translateX(0%); }
        }

        .giveaway-card {
            width: 100%; 
            max-width: 250px; 
            margin-top: 0; /* Uklonjen gapom od parenta */
            border-radius: 16px;
            overflow: hidden; 
            position: relative;
            border: 1px solid #3f3f46;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            animation: glow 2.5s infinite ease-in-out;
        }

        .slider-track {
            display: flex;
            width: 400%;
            height: 100%;
            animation: slideImages 16s infinite ease-in-out;
        }

        .slider-track img {
            width: 25%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head><body><div id="loader-overlay">
        <div class="loader-content">
            <img src="https://i.imgur.com/JlTXDe9.png" alt="Logo" class="loader-logo" onerror="this.style.display='none'">
            <div class="loader-spinner"></div>
        </div>
    </div>

    <div class="desktop-view">
        <div class="centered-content-wrapper">
            <div id="dailyWinPopover"></div> <div class="page-layout-container">
                <div class="auth-sidebar">
                    <a class="rulesLink w-full">
                        <i data-lucide="scroll-text" class="w-6 h-6 text-amber-400"></i>
                        <span>Pravila Lige</span>
                    </a>

                    <div id="authButtons" class="flex flex-col items-start gap-3 w-full">
                        <button id="loginButton" class="w-full text-center p-2.5 rounded-lg border-2 border-zinc-700 bg-zinc-800/50 hover:bg-zinc-700/60 transition-colors font-semibold"><i data-lucide="log-in" class="w-5 h-5 inline-block mr-2 align-middle"></i>Prijavi se</button>
                        <button id="registerButton" class="w-full text-center p-2.5 rounded-lg border-2 border-zinc-700 bg-zinc-800/50 hover:bg-zinc-700/60 transition-colors font-semibold"><i data-lucide="user-plus" class="w-5 h-5 inline-block mr-2 align-middle"></i>Registruj se</button>
                    </div>
                    
                    <div id="loggedInProfile" class="hidden relative w-full profile-card" style="padding: 8px;">
                        <button id="myProfileButton" class="flex items-start gap-2 p-2 rounded-lg hover:bg-zinc-900/20 w-full text-left transition-all duration-300 ease-in-out">
                            <img id="profilePic" src="https://placehold.co/48x48/52525b/a1a1aa?text=+" alt="Profilna slika" class="w-12 h-12 rounded-full object-cover flex-shrink-0 border-2 border-zinc-500">
                            <div class="flex-grow overflow-hidden">
                                <span id="profileUsername" class="text-white font-semibold text-xl block truncate"></span>
                                <div class="text-zinc-300 font-medium text-sm flex items-center mt-1">
                                    <span>Ukupno: </span><span id="userTotalPoints" class="ml-1.5 flex items-center font-semibold"></span>
                                </div>
                                <div class="text-zinc-400 font-medium text-sm flex items-center">
                                     <span>Danas: </span><span id="userDailyPoints" class="ml-1.5 flex items-center font-semibold"></span>
                                </div>
                            </div>
                        </button>
                    </div>

                    <button class="addTicketButton custom-button gradient-button"><i data-lucide="plus-circle"></i> Dodaj tiket</button>
                    
                    <div class="giveaway-card">
                        <div class="slider-track">
                            <img src="https://i.imgur.com/eYE5wtg.png" alt="Giveaway 1">
                            <img src="https://i.imgur.com/fyUZIgI.png" alt="Giveaway 2">
                            <img src="https://i.imgur.com/hXdTAE3.png" alt="Giveaway 3">
                            <img src="https://i.imgur.com/J650hIb.png" alt="Giveaway 4">
                        </div>
                    </div>
                    </div>

                <div class="main-content-wrapper">
                    <div class="w-full lg:flex-[3] card leaderboard-card">
                        <div class="mb-2 pb-2 border-b border-zinc-700">
                            <h1 class="main-title-container flex-grow">
                                <span class="main-title-text">
                                    <img src="https://i.imgur.com/JlTXDe9.png" alt="Kockari Pobedjuju Logo" onerror="this.onerror=null;this.src='https://placehold.co/120x80/3f3f46/facc15?text=LOGO';" >
                                    <div>
                                        <span class="gradient-title block">Kockari Pobedjuju</span>
                                        <span class="league-title-large block mt-[-0.8rem]">LIGA</span>
                                    </div>
                                    <img src="https://i.imgur.com/JlTXDe9.png" alt="Kockari Pobedjuju Logo" onerror="this.onerror=null;this.src='https://placehold.co/120x80/3f3f46/facc15?text=LOGO';" >
                                </span>
                                <span id="currentRound" class="block text-base font-medium text-zinc-400 mt-2 leading-tight">Učitavanje...</span>
                            </h1>
                        </div>
                        
                        <div class="relative mb-2 flex justify-end">
                            <div id="searchContainer" class="relative flex items-center">
                                 <div id="searchPopup">
                                    <input type="text" id="leaderboardSearch" placeholder="Pronađi korisnika...">
                                 </div>
                                 <button id="searchIcon" class="p-2 rounded-full hover:bg-zinc-700 transition-colors">
                                    <i data-lucide="search" class="text-zinc-400 w-3.5 h-3.5"></i>
                                 </button>
                            </div>
                        </div>

                        <div id="leaderboard-container-desktop" class="overflow-x-auto rounded-xl border border-zinc-700 table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="w-[8%]">Rang</th>
                                        <th class="w-[22%]">Korisničko Ime</th>
                                        <th class="w-[10%] text-center">DOBITNI</th>
                                        <th class="w-[10%] text-center">GUBITNI</th>
                                        <th class="w-[12%] text-center">PONIŠTENI</th>
                                        <th class="w-[12%] text-center">Uspešnost</th>
                                        <th class="w-[8%] text-center">ROI</th>
                                        <th class="w-[18%] text-center">PROFIT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="8" class="text-center p-8">Učitavanje podataka...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="w-full lg:flex-[1] flex flex-col gap-6">
                        <div class="card p-5">
                            <h2 class="text-xl font-bold text-white mb-3 pb-2 border-b border-zinc-700 text-center flex items-center justify-center gap-2">
                                <i data-lucide="bar-chart-3"></i>
                                <span>Statistika lige</span>
                            </h2>
                            <div id="leagueStatsContainer" class="space-y-1.5 text-sm">
                               <p class="text-center p-4">Učitavanje statistike...</p>
                            </div>
                        </div>
                        <div class="card p-6 bg-gradient-to-r from-blue-700 to-cyan-700 sponsor-card-hover-effect">
                            <h2 class="text-xl font-bold text-white mb-3 text-center">Naš cenjeni sponzor</h2>
                            <img src="https://placehold.co/400x100/3b82f6/ffffff?text=Sponsor+Logo" alt="Sponzorski Logotip" class="mb-4 mx-auto rounded-lg shadow-md w-full" />
                            <p class="text-blue-100 text-sm text-center">
                                Podržite našu ligu proveravajući <span class="font-bold text-white">Ime sponzora</span> za sve vaše sportske potrebe!
                            </p>
                            <a href="#" class="inline-block mt-4 px-6 py-3 bg-white text-blue-700 text-base font-semibold rounded-lg hover:bg-zinc-100 transition-all duration-200 ease-in-out text-center w-full shadow-md hover:shadow-lg hover:scale-105 transform">
                                Poseti sponzora
                            </a>
                        </div>
                        <div id="instagram-card" class="card p-0 bg-gradient-to-br from-purple-600 via-pink-600 to-yellow-500 overflow-hidden flex flex-col">
                            <div class="instagram-posts-container w-full h-full min-h-[520px] flex-grow relative">
                                <div class="p-8 text-white text-center flex items-center justify-center h-full">
                                    <span>Učitavanje objava...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <footer class="w-full max-w-6xl mx-auto mt-12 mb-6 text-zinc-400 text-xs p-6 rounded-2xl bg-zinc-900/50 border border-zinc-700">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="md:w-1/2 text-center md:text-left">
                        <p>Ovo nije sajt za klađenje pravim novcem, <br> već platforma za simulaciju i takmičenje u znanju i veštini.</p>
                    </div>
                    <div class="md:w-1/2 flex justify-center md:justify-end items-center gap-3">
                         <div class="eighteen-plus-circle">18+</div>
                        <p class="text-center md:text-right">Pristup platformi dozvoljen je isključivo <br> punoletnim licima.</p>
                    </div>
                </div>
            </footer>
            <div class="w-full text-center text-zinc-500" style="font-size: 0.7rem; padding-bottom: 1rem;">
                © 2025 Kockari Pobedjuju Liga. Sva prava zadržana.
            </div>
        </div>
    </div><div class="mobile-view">
        <header id="mobile-header" class="sticky top-0 z-40 bg-slate-900/80 backdrop-blur-sm border-b border-slate-700 w-full">
    <div class="flex justify-between items-center p-4 w-full max-w-screen-lg mx-auto">
        <div class="flex items-center gap-2 flex-shrink-0">
            <img src="https://i.imgur.com/JlTXDe9.png" alt="Logo" class="h-10">
            <h1 class="text-base font-extrabold leading-tight"><span class="gradient-title">Kockari Pobedjuju</span><span class="block text-white league-title-mobile">LIGA</span></h1>
        </div>
        <div id="mobile-profile-area" class="relative">
            </div>
    </div>
</header>

        <main id="mobile-content" class="w-full flex flex-col gap-4 p-4">
            <div class="w-full rounded-lg overflow-hidden relative border border-zinc-700 shadow-md aspect-[16/3]">
                <div class="slider-track">
                     <img src="https://i.imgur.com/ND45KS7.png" alt="Giveaway Mobile 1" class="h-full w-full object-contain">
                     <img src="https://i.imgur.com/QUR3sbh.png" alt="Giveaway Mobile 2" class="h-full w-full object-contain">
                     <img src="https://i.imgur.com/odiFSpz.png" alt="Giveaway Mobile 3" class="h-full w-full object-contain">
                     <img src="https://i.imgur.com/YMksiCr.png" alt="Giveaway Mobile 4" class="h-full w-full object-contain">
                </div>
            </div>
            <button class="addTicketButton custom-button gradient-button"><i data-lucide="plus-circle"></i> Dodaj tiket</button>
            
            <button id="mobileTabelaButton" class="custom-button bg-slate-700 hover:bg-slate-600"><i data-lucide="table-2"></i> Tabela</button>
            <button id="mobileStatistikaButton" class="custom-button bg-slate-700 hover:bg-slate-600"><i data-lucide="bar-chart-3"></i> Statistika Lige</button>

            <button class="rulesLink custom-button bg-slate-700 hover:bg-slate-600"><i data-lucide="scroll-text"></i> Pravila Lige</button>
            
            <div class="mt-4"></div>

            <a href="https://www.instagram.com/kockari_pobedjuju/" target="_blank" class="flex items-center justify-between p-3 rounded-2xl bg-zinc-900/70 border border-zinc-700 hover:bg-zinc-800/90 transition-colors no-underline shadow-lg">
    <div class="flex items-center gap-3">
        <img src="https://i.imgur.com/JlTXDe9.png" alt="Logo" class="h-10 w-10 rounded-full object-cover">
        <div>
            <p class="font-bold text-white">kockari_pobedjuju</p>
            <p class="text-sm text-zinc-400">Prati na Instagramu</p>
        </div>
    </div>
    <i data-lucide="instagram" class="w-10 h-10" style="color: #E4405F;"></i>
</a>

            <div class="card p-2 bg-gradient-to-r from-blue-700 to-cyan-700 sponsor-card-hover-effect">
                <h2 class="text-base font-bold text-white mb-2 text-center">Naš cenjeni sponzor</h2>
                <img src="https://placehold.co/400x60/3b82f6/ffffff?text=Sponsor+Logo" alt="Sponzorski Logotip" class="mb-2 mx-auto rounded-lg shadow-md w-full" />
                <a href="#" class="inline-block mt-1 px-6 py-1.5 bg-white text-blue-700 text-sm font-semibold rounded-lg hover:bg-zinc-100 transition-all duration-200 ease-in-out text-center w-full shadow-md hover:shadow-lg hover:scale-105 transform">
                    Poseti sponzora
                </a>
            </div>
            
        </main>

        <div id="mobile-footer">
            <span>Platforma za simulaciju klađenja – igra se bez pravog novca,                   isključivo u zabavne svrhe.</span>
            <div class="eighteen-plus-circle">18+</div>
        </div>
    </div>

    <div id="userHistoryModal" class="modal-overlay">
        <div class="modal-content p-0">
            <button class="modal-back-button hidden" id="userHistoryBackButton"><i data-lucide="arrow-left"></i></button>
            <button class="modal-close-button" data-close="userHistoryModal"><i data-lucide="x"></i></button>
            <div class="content-overlay">
                <div class="flex justify-center items-center gap-4 mb-6 border-b pb-3 border-zinc-700">
                    <img id="modalUserPic" src="https://placehold.co/64x64/52525b/a1a1aa?text=?" alt="Profilna slika korisnika" class="w-24 h-24 rounded-full object-cover border-2 border-zinc-500 flex-shrink-0">
                    <div class="text-left">
                        <h2 id="modalUserName" class="text-2xl font-bold text-white"></h2>
                        <div id="modalUserRank" class="font-bold text-xl -mt-1"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-6 gap-x-8 mb-6">
                    <div class="col-span-full sm:col-span-1 bg-zinc-700/50 p-4 rounded-lg border border-zinc-600 flex flex-col items-center">
                        <h3 class="text-lg font-semibold text-white mb-3 pb-2 flex items-center gap-2 w-full justify-center border-b border-zinc-600"><i data-lucide="user" class="w-5 h-5 text-blue-400"></i> Informacije</h3>
                        <div id="modalUserInfo" class="w-full text-sm space-y-2 mt-2"></div>
                    </div>
                    <div class="col-span-full sm:col-span-1 bg-zinc-700/50 p-4 rounded-lg border border-zinc-600 flex flex-col items-center">
                        <h3 class="text-lg font-semibold text-white mb-3 pb-2 flex items-center gap-2 w-full justify-center border-b border-zinc-600"><i data-lucide="gauge" class="w-5 h-5 text-blue-400"></i> Statistika</h3>
                        <div id="modalPlayerStats" class="w-full text-sm space-y-2 mt-2"></div>
                    </div>
                </div>
                
                <div id="centralTicketPopover"></div>

                <h3 class="text-base font-semibold text-zinc-200 mt-6 mb-4 text-center flex items-center gap-2 justify-center border-b pb-2 border-zinc-700"><i data-lucide="bar-chart" class="w-4 h-4 text-blue-400"></i> Ishodi opklada</h3>
                <div id="bettingOutcomesCircles" class="flex flex-wrap justify-center p-1.5 border border-zinc-700 rounded-lg bg-zinc-800/50"></div>
                <p class="text-xs text-zinc-400 mt-3 text-center">(D - dobitan, G - gubitan, P - poništen)</p>
                
                <h3 class="text-base font-semibold text-zinc-200 mt-6 mb-4 text-center flex items-center gap-2 justify-center border-b pb-2 border-zinc-700"><i data-lucide="award" class="w-4 h-4 text-amber-400"></i> Dostignuća (Trofeji)</h3>
                <div id="modalUserTrophies" class="flex flex-wrap justify-center items-start gap-4 p-2 min-h-[65px]">
                    <p class="text-zinc-500 text-sm">Nema osvojenih trofeja.</p>
                </div>
            </div>
        </div>
    </div>
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm">
            <button class="modal-close-button" data-close="loginModal"><i data-lucide="x"></i></button>
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Prijavi se</h2>
            <form id="loginForm" class="space-y-4">
                <input type="text" id="loginEmailUsername" class="input-field" placeholder="Email ili Korisničko ime" required oninvalid="this.setCustomValidity('Molimo Vas, popunite ovo polje.')" oninput="this.setCustomValidity('')">
                <div class="password-container">
                    <input type="password" id="loginPassword" class="input-field" placeholder="Lozinka" required oninvalid="this.setCustomValidity('Molimo Vas, popunite ovo polje.')" oninput="this.setCustomValidity('')">
                    <i data-lucide="eye" class="password-toggle" onclick="togglePasswordVisibility('loginPassword', this)"></i>
                </div>
                <div class="text-right">
                    <a href="#" id="forgotPasswordLink" class="text-sm text-sky-400 hover:underline">Zaboravljena lozinka?</a>
                </div>
                <button id="submitLogin" type="submit" class="custom-button gradient-button w-full">Prijavi se</button>
            </form>
        </div>
    </div>
    <div id="registerModal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm">
            <button class="modal-close-button" data-close="registerModal"><i data-lucide="x"></i></button>
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Registruj se</h2>
            <form id="registerForm" class="space-y-4">
                <input type="email" id="registerEmail" class="input-field" placeholder="Email" required oninvalid="this.setCustomValidity(this.value === '' ? 'Molimo Vas, popunite ovo polje.' : 'Molimo Vas, unesite ispravnu email adresu.')" oninput="this.setCustomValidity('')">
                <div class="password-container">
                    <input type="password" id="registerPassword" class="input-field" placeholder="Lozinka (min. 6 karaktera)" required minlength="6" oninvalid="this.setCustomValidity(this.value === '' ? 'Molimo Vas, popunite ovo polje.' : 'Lozinka mora imati najmanje 6 karaktera.')" oninput="this.setCustomValidity('')">
                    <i data-lucide="eye" class="password-toggle" onclick="togglePasswordVisibility('registerPassword', this)"></i>
                </div>
                <div class="password-container">
                    <input type="password" id="registerPasswordConfirm" class="input-field" placeholder="Potvrdite lozinku" required minlength="6" oninvalid="this.setCustomValidity('Molimo Vas, popunite ovo polje.')" oninput="this.setCustomValidity('')">
                    <i data-lucide="eye" class="password-toggle" onclick="togglePasswordVisibility('registerPasswordConfirm', this)"></i>
                </div>
               <input type="text" id="registerUsername" class="input-field" placeholder="Korisničko ime" required maxlength="14" minlength="4" oninvalid="if(this.validity.tooShort) { this.setCustomValidity('Korisničko ime mora sadržati minimalno 4 karaktera'); } else { this.setCustomValidity('Molimo Vas, popunite ovo polje.'); }" oninput="this.setCustomValidity('')">
<select id="registerCountry" class="select-field" required oninvalid="this.setCustomValidity('Molimo Vas, izaberite državu.')" oninput="this.setCustomValidity('')">
    <option value="" disabled selected>Izaberite državu</option>
    <option value="Albanija">Albanija</option>
    <option value="Bosna i Hercegovina">Bosna i Hercegovina</option>
    <option value="Crna Gora">Crna Gora</option>
    <option value="Hrvatska">Hrvatska</option>
    <option value="Mađarska">Mađarska</option>
    <option value="Makedonija">Makedonija</option>
    <option value="Srbija">Srbija</option>
    <option value="Slovenija">Slovenija</option>
</select>
<p class="text-xs italic text-zinc-400 mt-2 text-center">Korisničko ime i izbor države se ne mogu menjati nakon kreiranja naloga.</p>
                <button id="submitRegister" type="submit" class="custom-button gradient-button w-full">Registruj se</button>
            </form>
        </div>
    </div>
    <div id="verifyModal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm">
             <h2 class="text-2xl font-bold text-white mb-4 text-center">Verifikacija</h2>
             <p class="text-center text-zinc-300 mb-6">Unesite kod koji smo Vam poslali na email: <strong id="verifyEmailDisplay"></strong></p>
            <form id="verifyForm" class="space-y-4">
                <input type="text" id="verifyCode" class="input-field text-center text-2xl tracking-[8px]" placeholder="______" required maxlength="6" oninvalid="this.setCustomValidity('Molimo Vas, popunite ovo polje.')" oninput="this.setCustomValidity('')">
                <button id="submitVerify" type="submit" class="custom-button gradient-button w-full">Potvrdi</button>
            </form>
        </div>
    </div>
    
    <div id="addTicketModal" class="modal-overlay bet-slip-modal">
        <div class="modal-content p-0">
            <div class="content-overlay">
                <div class="bet-slip-header" style="background: transparent; border-bottom: 1px solid #f59e0b; margin-bottom: 1rem;">Dodaj Tiket</div>
                <button class="modal-close-button" data-close="addTicketModal"><i data-lucide="x"></i></button>
                <form id="addTicketForm" class="mt-4">
                    <div id="ticketInputsContainer" class="space-y-3"></div>
                    <div class="mt-6">
                        <label for="stakeInput" class="block text-zinc-300 text-sm font-semibold mb-2">Ulog:</label>
                        <input type="number" id="stakeInput" class="input-field" placeholder="Unesite ulog" value="20" required oninvalid="this.setCustomValidity('Molimo Vas, unesite ulog.')" oninput="this.setCustomValidity('')">
                        <p id="stakeError" class="text-xs text-red-500 mt-1 h-5 text-center"></p>
                        <p id="dailyPointsRemaining" class="text-xs text-zinc-400 mt-1 text-right flex items-center justify-end">Preostalo za danas: <span id="remainingPointsValue" class="ml-1">0</span></p>
                    </div>
                    <button id="submitTicket" type="submit" class="custom-button gradient-button w-full mt-6 shadow-lg">Pošalji tiket</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="myProfileModal" class="modal-overlay">
        <div class="modal-content w-full max-w-md profile-modal-content p-0">
             <div class="content-overlay">
                <button class="modal-close-button" data-close="myProfileModal"><i data-lucide="x"></i></button>
                <div class="text-center pt-4">
                    <div class="profile-pic-container">
                        <img id="profileModalPic" src="https://placehold.co/128x128/52525b/a1a1aa?text=+" alt="Profilna slika">
                        <input type="file" id="profilePicInput" class="hidden" accept="image/png, image/jpeg, image/gif">
                    </div>
                    <div class="relative inline-block">
                        <button id="changeProfilePicButton" class="mt-3 text-xs text-sky-400 hover:text-sky-300 flex items-center gap-2 mx-auto">
                            <i data-lucide="image-plus" class="w-4 h-4"></i>
                            <span>Promeni profilnu fotografiju</span>
                        </button>
                        <div id="profilePicMenu" class="hidden absolute left-1/2 -translate-x-1/2 bg-zinc-800 border border-zinc-700 rounded-lg shadow-lg p-2 mt-1 w-56 z-20">
                            <button id="addPhotoOption" class="w-full text-left px-3 py-1.5 text-sm rounded-md hover:bg-zinc-700 flex items-center gap-2">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                <span>Dodaj fotografiju</span>
                            </button>
                            <button id="removePhotoOption" class="w-full text-left px-3 py-1.5 text-sm rounded-md hover:bg-zinc-700 text-red-400 flex items-center gap-2">
                                 <i data-lucide="trash-2" class="w-4 h-4"></i>
                                <span>Ukloni trenutnu fotografiju</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-center items-baseline gap-2 mt-4">
                        <h3 id="profileModalUsername" class="font-bold text-white text-2xl"></h3>
                        <div id="profileModalRank" class="font-bold text-lg"></div>
                    </div>
                    <div class="text-zinc-400 text-sm mt-2">
                        <span id="profileModalCountry"></span> &bull; Pridružio se: <span id="profileModalJoinDate"></span>
                    </div>
                </div>

                <div class="space-y-3 mt-8">
                    <button id="profileModalMyTicketsButton" class="profile-option-button"><i data-lucide="ticket"></i> Moji Tiketi</button>
                    <button id="profileModalAchievementsButton" class="profile-option-button"><i data-lucide="award"></i> Dostignuća</button>
                    <button id="profileModalSettingsButton" class="profile-option-button"><i data-lucide="settings"></i> Podešavanja</button>
                    <button id="profileModalLogoutButton" class="profile-option-button text-red-400 hover:bg-red-900/50"><i data-lucide="log-out"></i> Odjavi se</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="myTicketsModal" class="modal-overlay">
        <div class="modal-content w-full max-w-lg p-0">
            <div class="content-overlay">
                <button class="modal-back-button" data-back="myProfileModal" data-close="myTicketsModal"><i data-lucide="arrow-left"></i></button>
                <button class="modal-close-button" data-close="myTicketsModal"><i data-lucide="x"></i></button>
                <h2 class="text-2xl font-bold text-white mb-6 text-center">Moji Tiketi</h2>
                <div id="myTicketsList" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                    </div>
            </div>
        </div>
    </div>
    
    <div id="achievementsModal" class="modal-overlay">
        <div class="modal-content w-full max-w-lg p-0 relative">
            <div id="bestTicketPopover"></div>
            <div class="content-overlay">
                <button class="modal-back-button" data-back="myProfileModal" data-close="achievementsModal"><i data-lucide="arrow-left"></i></button>
                <button class="modal-close-button" data-close="achievementsModal"><i data-lucide="x"></i></button>
                <h2 class="text-2xl font-bold text-white mb-4 text-center">Dostignuća</h2>

                <div id="achievementsSeasonSelectorContainer" class="flex justify-center items-center gap-2 mb-6 border-b border-zinc-700 pb-4 flex-wrap">
                    <p class="text-zinc-500 text-sm">Učitavanje sezona...</p>
                </div>

                <div id="achievementsStatsContainer" class="space-y-3">
                    <div class="bg-zinc-800/50 p-4 rounded-lg border border-zinc-700 text-center">
                        <p class="text-zinc-400">Učitavanje statistike...</p>
                    </div>
                </div>

                <h3 class="font-semibold text-white mt-8 mb-4 text-center border-t border-zinc-700 pt-4">Osvojeni Trofeji</h3>
                <div id="achievementsTrophiesContainer" class="flex flex-wrap justify-center items-start gap-4 p-2 min-h-[65px]">
                    <p class="text-zinc-500 text-sm">Nema osvojenih trofeja.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content w-full max-w-md p-0">
            <button class="modal-back-button" data-back="myProfileModal" data-close="settingsModal"><i data-lucide="arrow-left"></i></button>
            <button class="modal-close-button" data-close="settingsModal"><i data-lucide="x"></i></button>
            <div class="content-overlay pt-12">
                <h2 class="text-2xl font-bold text-white mb-6 text-center">Podešavanja</h2>
                
                <div id="changeEmailSection" class="form-section">
                    <h3>Promeni Email</h3>
                    <form id="changeEmailForm" class="space-y-3">
                        <div>
                            <label for="newEmailInput">Novi email:</label>
                            <input type="email" id="newEmailInput" class="input-field" required oninvalid="this.setCustomValidity(this.value === '' ? 'Molimo Vas, popunite ovo polje.' : 'Molimo Vas, unesite ispravnu email adresu.')" oninput="this.setCustomValidity('')">
                        </div>
                        <div class="password-container">
                            <label for="currentPasswordEmail">Trenutna lozinka:</label>
                            <input type="password" id="currentPasswordEmail" class="input-field" placeholder="Lozinka" required oninvalid="this.setCustomValidity('Molimo Vas, popunite ovo polje.')" oninput="this.setCustomValidity('')">
                            <i data-lucide="eye" class="password-toggle" onclick="togglePasswordVisibility('currentPasswordEmail', this)"></i>
                        </div>
                        <button type="submit" id="submitChangeEmail" class="custom-button gradient-button w-full !mt-4">Sačuvaj promenu</button>
                        <p id="emailChangeInfo" class="text-xs text-zinc-400 mt-2 text-center">Moguće promeniti samo po završetku sezone.</p>
                    </form>
                </div>

                <div class="form-section">
                    <h3>Promeni Lozinku</h3>
                    <form id="changePasswordForm" class="space-y-3">
                        <div class="password-container">
                            <label for="currentPasswordPassword">Trenutna lozinka:</label>
                            <input type="password" id="currentPasswordPassword" class="input-field" placeholder="Lozinka" required oninvalid="this.setCustomValidity('Molimo Vas, popunite ovo polje.')" oninput="this.setCustomValidity('')">
                            <i data-lucide="eye" class="password-toggle" onclick="togglePasswordVisibility('currentPasswordPassword', this)"></i>
                        </div>
                        <div class="password-container">
                            <label for="newPasswordInput">Nova lozinka (min. 6 karaktera):</label>
                            <input type="password" id="newPasswordInput" class="input-field" placeholder="Lozinka" required minlength="6" oninvalid="this.setCustomValidity(this.value === '' ? 'Molimo Vas, popunite ovo polje.' : 'Lozinka mora imati najmanje 6 karaktera.')" oninput="this.setCustomValidity('')">
                            <i data-lucide="eye" class="password-toggle" onclick="togglePasswordVisibility('newPasswordInput', this)"></i>
                        </div>
                        <div class="password-container">
                            <label for="confirmNewPasswordInput">Potvrdi novu lozinku:</label>
                            <input type="password" id="confirmNewPasswordInput" class="input-field" placeholder="Lozinka" required minlength="6" oninvalid="this.setCustomValidity(this.value === '' ? 'Molimo Vas, popunite ovo polje.' : 'Lozinka mora imati najmanje 6 karaktera.')" oninput="this.setCustomValidity('')">
                            <i data-lucide="eye" class="password-toggle" onclick="togglePasswordVisibility('confirmNewPasswordInput', this)"></i>
                        </div>
                        <button type="submit" id="submitChangePassword" class="custom-button gradient-button w-full !mt-4">Promeni lozinku</button>
                    </form>
                </div>

                <div id="adminSection" class="form-section hidden mt-6 border-t-2 border-red-500 pt-4">
                    <h3 class="text-lg font-bold text-red-400">Administratorske Akcije</h3>
                    <p class="text-xs text-zinc-400 mt-2 mb-4 text-center">Ove akcije su nepovratne. Koristiti sa oprezom na kraju sezone.</p>
                    <button type="button" id="archiveSeasonButton" class="custom-button bg-red-800 hover:bg-red-700 w-full">Arhiviraj Trenutnu Sezonu</button>
                </div>
                </div>
        </div>
    </div>

    <div id="rulesModal" class="modal-overlay">
        <div class="modal-content p-0">
            <button class="modal-close-button" data-close="rulesModal"><i data-lucide="x"></i></button>
            <div class="rules-container pt-12">
                <h2>Pravila Lige - Kockari Pobeđuju LIGA</h2>
                <p>Dobrodošli na Kockari Pobeđuju LIGU! Molimo vas da pažljivo pročitate sledeća pravila kako biste u potpunosti razumeli kako funkcioniše naša platforma.</p>
                <h3>1. REGISTRACIJA I PRIJAVA</h3>
                <p>Kako biste postali član Lige, potrebno je da:</p>
                <ul>
                    <li>Registrujete svoj nalog putem Email adrese i lozinke (minimalno 6 karaktera).</li>
                    <li>Unesete svoje korisničko ime i izaberete državu.</li>
                    <li>Nakon registracije, na Email će vam stići kod za verifikaciju koji je potrebno uneti radi potvrde naloga.</li>
                    <li>Nakon verifikacije, možete se prijaviti unosom Emaila ili korisničkog imena i lozinke.</li>
                </ul>
                <h3>2. SLANJE TIKETA</h3>
                <p>Slanje tiketa vrši se klikom na dugme "Dodaj Tiket".</p>
                <ul>
                    <li>Otvoriće vam se formular u kom unosite svoje parove i tipove.</li>
                    <li>Svaki red predstavlja jedan par sa tipom. Ukoliko želite više parova, kliknite na dugme "+ Dodaj par".</li>
                </ul>
                <p class="mt-2"><b>Kako unosite par i tip?</b><br>Naš sajt nema unapred definisanu sportsku ponudu, što znači da možete igrati bilo koji sportski događaj koji postoji u kladionicama.</p>
                <p class="mt-2"><b>Primeri unosa:</b><br>U polje za par: <i>PSG - Real </i>, u polje za tip: <i>1</i><br>U polje za par: <i>N.Jokić</i>, u polje za tip: <i>35.5+</i></p>
                <p class="mt-2">Zatim ispod unesite visinu uloga (minimalno 20 poena) za taj tiket.  Svaki korisnik ima početnih 1000 poena, ali dnevno možete koristiti maksimalno 100 poena.</p>
                <p class="mt-2">Nakon što ste uneli sve parove, tipove i ulog, kliknite na "Pošalji tiket".</p>
                <h3>3. PREGLED TIKETA</h3>
                <p>Svoje tikete možete pogledati tako što kliknete na Vašu profilnu fotografiju u ćošku, gde će se pojaviti opcija za pregled tiketa sa kvotama i statusom.</p>
                <h3>4. POENI</h3>
                <ul>
                    <li>Svaki novi član dobija 1000 poena, ali dnevno može iskoristiti samo 100.</li>
                    <li>Poeni važe samo za tekuću sezonu i ne prenose se u narednu.</li>
                    <li>Novi poeni se dodeljuju na početku svake nove sezone.</li>
                </ul>
                <h3>5. TABELA</h3>
                <ul>
                    <li>Svaki registrovani član koji ima bar jedan dobitan ili gubitan tiket, pojavljuje se na tabeli.</li>
                    <li>Tabela prikazuje broj dobitnih (D), gubitnih (G) i poništenih (P) tiketa, uspešnost, profit, kao i procentualnu zaradu na investirano.</li>
                    <li>Korisnik koji na kraju sezone nema minimalno 10 odigranih tiketa (dobitni+gubitni) neće biti rangiran.</li>
                    <li>Top 3 igrača na kraju sezone osvajaju nagrade kroz giveaway.</li>
                </ul>
                <h3>6. SEZONE</h3>
                <ul>
                    <li>Svaka sezona traje 30 kola (30 dana).</li>
                    <li>U ligu se možete pridružiti kad god želite.</li>
                    <li>Parovi na tiketu koji se odigravaju nakon poslednjeg kola u sezoni činiće tiket nevažećim.</li>
                    <li>Svaki korisnik koji bude imao manje od 10 odigranih tiketa (dobitni+gubitni) na kraju sezone biće diskvalifikovan!</li>
                    <li>Nove sezone počinju u roku od nekoliko dana nakon završetka prethodne. </li>
                </ul>
                <h3>7. OGRANIČENJA I ODGOVORNOST</h3>
                <ul>
                    <li>Osobama mlađim od 18 godina zabranjeno je učestvovanje.</li>
                    <li>Na sajtu se ne koristi pravi novac.</li>
                    <li>Svi ulogovani poeni su virtuelni i služe isključivo u zabavne i takmičarske svrhe.</li>
                </ul>
                <h3>8. PRIRODA TAKMIČENJA</h3>
                <ul>
                    <li>Ovo takmičenje je zasnovano na veštini (skill-based competition), i nije igra na sreću.</li>
                    <li>Koristi se isključivo virtuelni novac (poeni) i ne postoji nikakav realan finansijski ulog niti rizik.</li>
                    <li>Najbolje rangiran takmičar je onaj sa najvećim ostvarenim profitom na kraju sezone, a da ima minimalno 10 odigranih tiketa (dobitni + gubitni).</li>
                    <li>Tri najbolje rangirana takmičara na kraju sezone ostvaruju pravo na učešće u našem giveaway-u.</li>
                </ul>
                <h3>9. DISKVALIFIKACIJA</h3>
                <ul>
                    <li>Svaki vid zloupotrebe sistema, bagova ili pokušaj varanja rezultiraće momentalnom diskvalifikacijom.</li>
                    <li>Zabranjeno je korišćenje psovki, uvredljivih ili neprimerenih reči u korisničkom imenu ili sadržaju tiketa.</li>
                    <li>Administratori zadržavaju pravo da diskvalifikuju svakog korisnika koji krši pravila ili narušava sportski duh takmičenja.</li>
                </ul>
                    <h3>10. POLITIKA PRIVATNOSTI</h3>
                <ul>
                    <li>Svi podaci o korisnicima, uključujući korisnička imena, statistike (kao što su rezultati tiketa, nizovi) i osvojeni trofeji, prikupljaju se radi vođenja i transparentnosti lige, te su javno dostupni unutar platforme.</li>
                    <li> Lični podaci (poput email adresa, lozinki i drugih kontakt informacija) se ne dele sa trećim licima i strogo su zaštićeni. Pristup podacima je ograničen na organizatore lige i služi isključivo za administraciju i održavanje sistema.</li>
                </ul>
                <p class="mt-4">Za sve dodatne informacije i podršku, obratite nam se putem kontakt stranice <a href="https://www.instagram.com/kockari_pobedjuju/" target="_blank" class="text-sky-400 hover:underline">https://www.instagram.com/kockari_pobedjuju/</a></p>
                <p class="mt-4">Čestitamo vam na pridruženju i želimo vam puno uspeha u igri!<br><b>Kockari Pobeđuju Tim.</b></p>
                <div class="flex justify-center mt-8">
                    <img src="https://i.imgur.com/JlTXDe9.png" alt="Kockari Pobedjuju Logo" class="h-20" onerror="this.onerror=null;this.src='https://placehold.co/120x80/3f3f46/facc15?text=LOGO';">
                </div>
            </div>
        </div>
    </div>
    
    <div id="tabelaModal" class="modal-overlay">
        <div id="mobile-leaderboard-modal" class="modal-content w-full max-w-xl p-0">
            <div class="content-overlay">
                <button class="modal-close-button" data-close="tabelaModal"><i data-lucide="x"></i></button>
                <h2 class="text-2xl font-bold text-white mb-4 text-center">Tabela</h2>
                <div id="mobile-table-wrapper" class="rounded-lg border border-zinc-700 mt-4">
                     <table class="w-full text-sm" style="table-layout: auto;">
                        <thead>
                            <tr>
                                <th class="p-2">R.</th>
                                <th class="p-2">Korisnik</th>
                                <th class="p-2 text-center">Profit</th>
                                <th class="extended-col p-2 text-center">D</th>
                                <th class="extended-col p-2 text-center">G</th>
                                <th class="extended-col p-2 text-center">P</th>
                                <th class="extended-col p-2 text-center">Usp.</th>
                                <th class="extended-col p-2 text-center">ROI</th>
                            </tr>
                        </thead>
                        <tbody id="mobile-leaderboard-tbody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="statistikaLigeModal" class="modal-overlay">
        <div class="modal-content w-full max-w-md p-0">
             <div class="content-overlay">
                <button class="modal-close-button" data-close="statistikaLigeModal"><i data-lucide="x"></i></button>
                <h2 class="text-2xl font-bold text-white mb-6 text-center">Statistika Lige</h2>
                <div id="leagueStatsContainerModal" class="space-y-1.5 text-base">
                   </div>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm p-0">
            <div class="content-overlay">
                <h2 id="confirmModalTitle" class="text-xl font-bold text-white mb-4 text-center"></h2>
                <p id="confirmModalMessage" class="text-center text-zinc-300 mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button id="confirmModalCancel" class="custom-button bg-zinc-600 hover:bg-zinc-500 w-1/2">Otkaži</button>
                    <button id="confirmModalConfirm" class="custom-button gradient-button w-1/2">Potvrdi</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirmPasswordResetModal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm p-0">
            <div class="content-overlay">
                <h2 class="text-xl font-bold text-white mb-4 text-center">Potvrda email adrese</h2>
                <p class="text-center text-zinc-300 mb-6">Poslaćemo link za resetovanje lozinke na adresu: <br><strong id="confirmResetEmailDisplay" class="text-white"></strong></br>Da li želite da nastavite?</p>
                <div class="flex justify-center gap-4">
                    <button id="cancelReset" class="custom-button bg-zinc-600 hover:bg-zinc-500 w-1/2">Otkaži</button>
                    <button id="confirmReset" class="custom-button gradient-button w-1/2">Pošalji link</button>
                </div>
            </div>
        </div>
    </div>

    <div id="resetPasswordModal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Postavi novu lozinku</h2>
            <form id="resetPasswordForm" class="space-y-4">
                <input type="hidden" id="resetTokenInput">
                <div class="password-container">
                    <input type="password" id="resetNewPassword" class="input-field" placeholder="Nova lozinka (min. 6 karaktera)" required minlength="6">
                    <i data-lucide="eye" class="password-toggle" onclick="togglePasswordVisibility('resetNewPassword', this)"></i>
                </div>
                <div class="password-container">
                    <input type="password" id="resetConfirmPassword" class="input-field" placeholder="Potvrdite novu lozinku" required minlength="6">
                    <i data-lucide="eye" class="password-toggle" onclick="togglePasswordVisibility('resetConfirmPassword', this)"></i>
                </div>
                <button id="submitResetPassword" type="submit" class="custom-button gradient-button w-full">Sačuvaj lozinku</button>
            </form>
        </div>
    </div>

    <div id="dailyWinOverlay" class="mobile-popover-overlay" style="display: none;"></div>
    <div id="toast-container"></div>
    
<script>
    // --- SETTINGS ---
    const DAILY_POINT_LIMIT = 100;
    const INITIAL_TOTAL_POINTS = 1000;
    const MIN_STAKE = 20;
    const COIN_IMAGE_URL = 'https://i.imgur.com/oV8njyX.png';
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz80a8Rkt4pWCRoISrxGshmqq9-9x02AYKk89o2I7tQKRQT9QwrbOYRj8yfFAVmHjwreg/exec';
    const TROPHY_DEFINITIONS = {
        // Sezonski trofeji
        'zlatna_serija': { name: 'Zlatna serija', description: 'Ostvareno minimalno 5 uzastopnih dobitnih tiketa', img: 'https://i.imgur.com/j7eCnfN.png', type: 'seasonal' },
        'teskas': { name: 'Teškaš', description: 'Ostvareno minimalno 8 uloga iznad 80 poena', img: 'https://i.imgur.com/pFTpy6B.png', type: 'seasonal' },
        'probijen_led': { name: 'Probijen led', description: 'Ostvaren prvi dobitni tiket', img: 'https://i.imgur.com/PutMfzz.png', type: 'seasonal' },
        'sruseni_snovi': { name: 'Srušeni snovi', description: 'Ostvareno 5 uzastopnih gubitnih tiketa', img: 'https://i.imgur.com/TT6bUyL.png', type: 'seasonal' },
        'oprezni_takmicar': { name: 'Štediša', description: 'Ostvareno minimalno 8 uloga ispod 40 poena', img: 'https://i.imgur.com/tVIxpN7.png', type: 'seasonal' },
        'jackpot_kralj': { name: 'Jackpot kralj', description: 'Ostvareno minimalno 3 dobitna tiketa sa kvotom većom od 5', img: 'https://i.imgur.com/FFIgjPS.png', type: 'seasonal' },
        'maratonac': { name: 'Maratonac', description: 'Ostvareno minimalno 20 tiketa u sezoni', img: 'https://i.imgur.com/NtFA0V1.png', type: 'seasonal' },
        'kralj_sigurica': { name: 'Kralj sigurica', description: 'Ostvareno minimalno 7 dobitnih tiketa sa kvotom manjom od 2', img: 'https://i.imgur.com/whttSbl.png', type: 'seasonal' },
        'luzer': { name: 'Luzer', description: 'Korisnik koji izgubi svih 1000 poena', img: 'https://i.imgur.com/ubZUdJ5.png', type: 'seasonal' },
        'povratnik': { name: 'Povratnik', description: 'Nakon 3 uzastopna gubitna tiketa, ostvarena su 3 uzastopna dobitna', img: 'https://i.imgur.com/DqUvscB.png', type: 'seasonal' },
        // Stalni trofeji
        'sampion': { name: 'Šampion Sezone', description: 'Osvojeno 1. mesto na kraju sezone', img: 'https://i.imgur.com/5NgilQS.png', type: 'permanent' },
        'vicesampion': { name: 'Vicešampion Sezone', description: 'Osvojeno 2. mesto na kraju sezone', img: 'https://i.imgur.com/fpQlgOv.png', type: 'permanent' },
        'bronza': { name: 'Bronzani takmičar', description: 'Osvojeno 3. mesto na kraju sezone', img: 'https://i.imgur.com/EZ5HBz2.png', type: 'permanent' },
        'kralj_kladionice': { name: 'Kralj kladionice', description: 'Minimalno tri puta osvojeno 1. mesto u sezoni', img: 'https://i.imgur.com/p1eugRv.png', type: 'permanent' }
    };

    // --- GLOBALNE PROMENLJIVE I KEŠ ---
    let currentUser = null;
    let appCache = {
        users: [],
        tickets: [],
        history: [],
        leaderboard: [],
        rankedLeaderboard: [],
        leagueStats: {},
        settings: {},
        isDataLoaded: false,
        isHistoryLoaded: false
    };
    let currentSeasonInfo = { season: 1, round: 1, isOffSeason: true }; 

    // --- DEKLARACIJA DOM ELEMENATA ---
    let loaderOverlay, authButtons, loggedInProfile, profilePic, profileUsername, userTotalPoints,
        userDailyPoints, myProfileButton, myProfileModal, profileModalPic, profileModalUsername,
        profileModalJoinDate, profileModalCountry, profileModalRank, myTicketsModal,
        achievementsModal, settingsModal, stakeInput, stakeError, remainingPointsValue,
        rulesModal, leaderboardSearch, searchIcon, searchContainer, searchPopup,
        mobileProfileArea, tabelaModal, statistikaLigeModal, userHistoryModal,
        userHistoryBackButton, confirmModal, confirmPasswordResetModal, resetPasswordModal,
        changeProfilePicButton, profilePicInput, profilePicMenu; 

    // --- INICIJALIZACIJA ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- DODELJIVANJE VREDNOSTI DOM ELEMENTIMA ---
        loaderOverlay = document.getElementById('loader-overlay');
        authButtons = document.getElementById('authButtons');
        loggedInProfile = document.getElementById('loggedInProfile');
        profilePic = document.getElementById('profilePic');
        profileUsername = document.getElementById('profileUsername');
        userTotalPoints = document.getElementById('userTotalPoints');
        userDailyPoints = document.getElementById('userDailyPoints');
        myProfileButton = document.getElementById('myProfileButton');
        myProfileModal = document.getElementById('myProfileModal');
        profileModalPic = document.getElementById('profileModalPic');
        profileModalUsername = document.getElementById('profileModalUsername');
        profileModalJoinDate = document.getElementById('profileModalJoinDate');
        profileModalCountry = document.getElementById('profileModalCountry');
        profileModalRank = document.getElementById('profileModalRank');
        myTicketsModal = document.getElementById('myTicketsModal');
        achievementsModal = document.getElementById('achievementsModal');
        settingsModal = document.getElementById('settingsModal');
        stakeInput = document.getElementById('stakeInput');
        stakeError = document.getElementById('stakeError');
        remainingPointsValue = document.getElementById('remainingPointsValue');
        rulesModal = document.getElementById('rulesModal');
        leaderboardSearch = document.getElementById('leaderboardSearch');
        searchIcon = document.getElementById('searchIcon');
        searchContainer = document.getElementById('searchContainer');
        searchPopup = document.getElementById('searchPopup');
        mobileProfileArea = document.getElementById('mobile-profile-area');
        tabelaModal = document.getElementById('tabelaModal');
        statistikaLigeModal = document.getElementById('statistikaLigeModal');
        userHistoryModal = document.getElementById('userHistoryModal');
        userHistoryBackButton = document.getElementById('userHistoryBackButton');
        confirmModal = document.getElementById('confirmModal');
        confirmPasswordResetModal = document.getElementById('confirmPasswordResetModal');
        resetPasswordModal = document.getElementById('resetPasswordModal');
        changeProfilePicButton = document.getElementById('changeProfilePicButton');
        profilePicInput = document.getElementById('profilePicInput');
        profilePicMenu = document.getElementById('profilePicMenu');


        // --- GLAVNA LOGIKA APLIKACIJE ---
        setupEventListeners();

        const initializeApp = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('resetToken');

            if (token) {
                // --- Brza putanja za resetovanje lozinke ---
                try {
                    showToast('Provera tokena...', 'info');
                    await callGAS('verifyResetToken', { token });
                    document.getElementById('resetTokenInput').value = token;
                    hideLoader();
                    openModal(resetPasswordModal);
                    lucide.createIcons();
                } catch (error) {
                    console.error('Token nije važeći ili je istekao:', error);
                    showToast(error.message, 'error');
                    window.history.replaceState({}, document.title, window.location.pathname);
                    hideLoader();
                    updateAuthUI(false);
                    lucide.createIcons();
                }
            } else {
                // --- Normalno učitavanje aplikacije ---
                await loadFullApp();
            }
        };

        const loadFullApp = async () => {
             try {
                checkLoginStatus(); 
                await fetchAndCacheAllData();
            } catch (error) {
                console.error("Kritična greška pri inicijalizaciji:", error);
                showToast('Greška pri učitavanju aplikacije. Molimo osvežite stranicu.', 'error');
            } finally {
                hideLoader();
                lucide.createIcons();
            }
        };

        initializeApp();
    });

    // --- POMOĆNE FUNKCIJE ---
    function hideLoader() {
        if (loaderOverlay) {
            loaderOverlay.classList.add('loader-fade-out');
            loaderOverlay.addEventListener('transitionend', () => {
                loaderOverlay.style.display = 'none';
            }, { once: true });
        }
    }

    function getCountryImage(country) {
        const countryImageMap = {
            'Albanija':
'https://upload.wikimedia.org/wikipedia/commons/3/36/Flag_of_Albania.svg',
            'Srbija': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Flag_of_Serbia.svg',
            'Crna Gora': 'https://upload.wikimedia.org/wikipedia/commons/6/64/Flag_of_Montenegro.svg',
            'Hrvatska': 'https://upload.wikimedia.org/wikipedia/commons/1/1b/Flag_of_Croatia.svg',
            'Bosna i Hercegovina': 'https://upload.wikimedia.org/wikipedia/commons/b/bf/Flag_of_Bosnia_and_Herzegovina.svg',
            'Slovenija': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Flag_of_Slovenia.svg',
            'Mađarska':
'https://upload.wikimedia.org/wikipedia/commons/c/c1/Flag_of_Hungary.svg',
            'Makedonija': 'https://upload.wikimedia.org/wikipedia/commons/7/79/Flag_of_North_Macedonia.svg'
        };
        return countryImageMap[country] || 'https://placehold.co/48x48/52525b/a1a1aa?text=?';
    }
    
   function getUserDisplayImage(user) {
        if (user && user.ProfilnaSlika && (user.ProfilnaSlika.startsWith('https://') || user.ProfilnaSlika.startsWith('data:image'))) {
            return user.ProfilnaSlika;
        }
        return getCountryImage(user ? user.Drzava : '');
    }

    function getCountryAbbreviation(country) {
        const countryAbbrMap = {
            'Srbija': 'SRB', 'Crna Gora': 'MNE', 'Hrvatska': 'HRV',
            'Bosna i Hercegovina': 'BIH', 'Slovenija': 'SVN', 'Makedonija': 'MKD',
            'Albanija': 'ALB', 'Mađarska': 'HUN'
        };
        return countryAbbrMap[country] || '';
    }
    
    function formatDate(dateString, includeTime = false) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';

        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();

        let datePart = day + '/' + month + '/' + year;

        if (includeTime) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return datePart + ' ' + hours + ':' + minutes;
        }
        return datePart;
    }
    
    function createCoinImg() {
        return `<img src="${COIN_IMAGE_URL}" alt="Novčić" class="coin-icon ml-1">`;
    }

    function getTiketPlural(count) {
        const lastDigit = count % 10;
        const lastTwoDigits = count % 100;
        if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
            return 'tiketa';
        }
        if (lastDigit === 1) {
            return 'tiket';
        }
        if (lastDigit >= 2 && lastDigit <= 4) {
            return 'tiketa';
        }
        return 'tiketa';
    }

    function getCurrentDailyPointsUsed() {
        if (!currentUser) return DAILY_POINT_LIMIT;
        return parseFloat(currentUser.DnevnoPotroseno || 0);
    }

    function updateSeasonAndRoundDisplay() {
        const settings = appCache.settings;
        if (!settings || !settings.datumPocetkaSezone || !settings.trenutnaSezona) {
            document.getElementById('currentRound').innerHTML = 'Sezona nije konfigurisana.';
            currentSeasonInfo.isOffSeason = true;
            return;
        }

        const startDate = new Date(settings.datumPocetkaSezone);
        const now = new Date();
        
        currentSeasonInfo.season = parseInt(settings.trenutnaSezona);

        if (now < startDate) {
             const roundDisplay = document.getElementById('currentRound');
             if(roundDisplay) roundDisplay.innerHTML = `Liga počinje ${formatDate(settings.datumPocetkaSezone)}`;
             currentSeasonInfo.isOffSeason = true;
             currentSeasonInfo.round = 1;
             return;
        }

        const diffTime = now - startDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        const seasonLength = 30;
        const round = diffDays + 1;
        
        const roundDisplay = document.getElementById('currentRound');
        if (round > seasonLength) {
            currentSeasonInfo.round = seasonLength;
            currentSeasonInfo.isOffSeason = true;
            if(roundDisplay) roundDisplay.innerHTML = `Kraj Sezone ${currentSeasonInfo.season}! Pauza do početka nove sezone.`;
        } else {
            currentSeasonInfo.round = round;
            currentSeasonInfo.isOffSeason = false;
            if(roundDisplay) roundDisplay.innerHTML = `Sezona ${currentSeasonInfo.season} / Kolo ${round}`;
        }
    }

    // --- SLUŠAOCI DOGAĐAJA ---
    function setupEventListeners() {
        document.getElementById('loginButton').addEventListener('click', () => openModal(document.getElementById('loginModal')));
        document.getElementById('registerButton').addEventListener('click', () => openModal(document.getElementById('registerModal')));
        
        document.querySelectorAll('.addTicketButton').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!currentUser) {
                    showToast('Morate biti prijavljeni da biste dodali tiket.', 'error');
                    openModal(document.getElementById('loginModal'));
                    return;
                }
                if (currentSeasonInfo.isOffSeason) {
                    showToast('Nije moguće slati tikete van sezone.', 'info');
                    return;
                }
            
                document.getElementById('ticketInputsContainer').innerHTML = '';
                addTicketInputField();
                updateDailyPointsDisplay();
                openModal(document.getElementById('addTicketModal'));
            });
        });

        document.querySelectorAll('.rulesLink').forEach(link => link.addEventListener('click', () => openModal(rulesModal)));

        document.querySelectorAll('.modal-close-button').forEach(btn => {
            const modalId = btn.dataset.close;
            btn.addEventListener('click', () => closeModal(document.getElementById(modalId)));
        });
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(overlay) });
        });
        document.querySelectorAll('.modal-back-button:not(#userHistoryBackButton)').forEach(btn => {
            const currentModalId = btn.dataset.close;
            const targetModalId = btn.dataset.back;
            btn.addEventListener('click', () => {
                closeModal(document.getElementById(currentModalId));
                openModal(document.getElementById(targetModalId));
            });
        });
        
        userHistoryBackButton.addEventListener('click', () => {
            const targetModalId = userHistoryModal.dataset.openedFrom;
            closeModal(userHistoryModal);
            if (targetModalId) openModal(document.getElementById(targetModalId));
        });

        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('registerForm').addEventListener('submit', handleRegister);
        document.getElementById('verifyForm').addEventListener('submit', handleVerify);
        document.getElementById('addTicketForm').addEventListener('submit', handleAddTicket);
        document.getElementById('changeEmailForm').addEventListener('submit', handleChangeEmail);
        document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
        
        myProfileButton.addEventListener('click', showMyProfile);
        document.getElementById('profileModalMyTicketsButton').addEventListener('click', () => { closeModal(myProfileModal); showMyTickets(); });
        document.getElementById('profileModalAchievementsButton').addEventListener('click', () => { closeModal(myProfileModal); showAchievements(); });
        document.getElementById('profileModalSettingsButton').addEventListener('click', () => { closeModal(myProfileModal); showSettings(); });
        document.getElementById('profileModalLogoutButton').addEventListener('click', handleLogout);
        
        changeProfilePicButton.addEventListener('click', (e) => {
            e.stopPropagation();
            profilePicMenu.classList.toggle('hidden');
        });
        document.getElementById('addPhotoOption').addEventListener('click', () => {
            profilePicInput.click();
            profilePicMenu.classList.add('hidden');
        });
        document.getElementById('removePhotoOption').addEventListener('click', () => {
            handleRemoveProfilePicture();
            profilePicMenu.classList.add('hidden');
        });
        profilePicInput.addEventListener('change', handleProfilePictureSelect);
        document.addEventListener('click', (e) => {
            if (!profilePicMenu.classList.contains('hidden') && !changeProfilePicButton.contains(e.target)) {
                profilePicMenu.classList.add('hidden');
            }
        });


        stakeInput.addEventListener('input', () => {
            stakeError.innerHTML = ''; // Clear previous error
            const stakeValue = parseInt(stakeInput.value);
            const dailyRemaining = DAILY_POINT_LIMIT - getCurrentDailyPointsUsed();

            if (stakeValue < MIN_STAKE) {
                stakeError.innerHTML = `Minimalni ulog po tiketu je ${MIN_STAKE} ${createCoinImg()}`;
            } else if (stakeValue > dailyRemaining) {
                 stakeError.innerHTML = `Maksimalni dnevni ulog je ${dailyRemaining} ${createCoinImg()}`;
            } else if (currentUser && stakeValue > parseFloat(currentUser.UkupnoPoena)) {
                 stakeError.innerHTML = `Nemate dovoljno poena. Stanje: ${parseFloat(currentUser.UkupnoPoena).toFixed(2)} ${createCoinImg()}`;
            }
            
            updateDailyPointsDisplay();
            lucide.createIcons();
        });
        
        searchIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            searchPopup.classList.toggle('show');
            if (searchPopup.classList.contains('show')) leaderboardSearch.focus();
        });

        document.addEventListener('click', (e) => {
            if (!searchContainer.contains(e.target)) searchPopup.classList.remove('show');
        });
        
        leaderboardSearch.addEventListener('input', handleLeaderboardSearch);

        document.getElementById('mobileTabelaButton').addEventListener('click', () => openModal(tabelaModal));
        document.getElementById('mobileStatistikaButton').addEventListener('click', () => openModal(statistikaLigeModal));

        document.getElementById('forgotPasswordLink').addEventListener('click', handleForgotPasswordRequest);
        document.getElementById('confirmReset').addEventListener('click', handleSendResetLink);
        document.getElementById('cancelReset').addEventListener('click', () => closeModal(confirmPasswordResetModal));
        document.getElementById('resetPasswordForm').addEventListener('submit', handleResetPassword);
    }

    // --- RUKOVANJE PODACIMA I KEŠIRANJE ---
    async function callGAS(functionName, data = {}) {
        if (!GOOGLE_APPS_SCRIPT_URL) {
            console.error('Google Apps Script URL nije konfigurisan.');
            showToast('Greška: URL servera nije podešen.', 'error');
            throw new Error('Google Apps Script URL not configured.');
        }

        const payload = {
            action: functionName,
            payload: data
        };

        try {
            const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                redirect: 'follow'
            });
            
            const result = await response.json();
            
            if (result.status === 'error') {
                throw new Error(result.message);
            }
            return result;

        } catch (error) {
            console.error(`Greška pri pozivanju GAS funkcije ${functionName}:`, error);
            const errorMessage = error.message.includes('Failed to fetch') 
                ? 'Greška u komunikaciji sa serverom (CORS ili mreža). Proverite da li ste ispravno objavili skriptu.'
                : `Greška sa servera: ${error.message}`;
            showToast(errorMessage, 'error');
            throw error;
        }
    }

    async function fetchAndCacheAllData() {
        console.log("Preuzimanje i keširanje svih podataka aplikacije...");
        try {
            const data = await callGAS('getLeagueData'); 
            
            if (data.status === 'success') {
                appCache.users = data.users;
                appCache.tickets = data.tickets; 
                appCache.settings = data.settings;
if (currentUser && currentUser.ProfilnaSlika && currentUser.ProfilnaSlika.startsWith('data:image')) {
                    const userInCache = appCache.users.find(u => u.KorisnikID === currentUser.KorisnikID);
                    if (userInCache) {
                        userInCache.ProfilnaSlika = currentUser.ProfilnaSlika;
                    }
                }
                appCache.isDataLoaded = true;
                
                updateSeasonAndRoundDisplay();
                calculateAndCacheStats();
                
                console.log("Podaci uspešno keširani i obrađeni.", appCache);

                renderLeaderboard();
                renderLeagueStats();
                renderInstagramPosts();
                updateAuthUI(currentUser !== null);
            }

        } catch (error) {
            console.error("Nije uspelo preuzimanje i keširanje podataka:", error);
        }
    }
    
    async function fetchHistoryData() {
        if (appCache.isHistoryLoaded) return;
        try {
            console.log("Preuzimanje istorijskih podataka...");
            const data = await callGAS('getHistoryData');
            if (data.status === 'success') {
                appCache.history = data.history;
                appCache.isHistoryLoaded = true;
                console.log("Istorijski podaci uspešno preuzeti.", appCache.history);
            }
        } catch (error) {
            console.error("Nije uspelo preuzimanje istorijskih podataka:", error);
            showToast('Greška pri učitavanju istorije sezona.', 'error');
        }
    }
    
    // --- LOGIKA ZA TROFEJE ---
    function checkAllTrophiesForUser(user, userTickets) {
        const earnedTrophies = new Set();
        const finishedTickets = userTickets.filter(t => t.Status !== 'Aktivan' && t.Status !== 'Poništen').sort((a,b) => new Date(a.Datum) - new Date(b.Datum));
        if (finishedTickets.length === 0) return [];
        
        // Probijen led
        if (finishedTickets.some(t => t.Status === 'Dobitan')) {
            earnedTrophies.add('probijen_led');
        }

        // Maratonac
        if (userTickets.length >= 20) {
            earnedTrophies.add('maratonac');
        }
        
        // Jackpot kralj
        const jackpotTickets = finishedTickets.filter(t => t.Status === 'Dobitan' && parseFloat(t.Kvota) > 5).length;
        if (jackpotTickets >= 3) {
            earnedTrophies.add('jackpot_kralj');
        }
        
        // Kralj sigurica
        const siguricaTickets = finishedTickets.filter(t => t.Status === 'Dobitan' && parseFloat(t.Kvota) < 2).length;
        if (siguricaTickets >= 7) {
            earnedTrophies.add('kralj_sigurica');
        }
        
        // Teškaš
        const highStakes = userTickets.filter(t => parseFloat(t.Ulog) > 80).length;
        if (highStakes >= 8) {
            earnedTrophies.add('teskas');
        }

        // Takmičar oprezni
        const lowStakes = userTickets.filter(t => parseFloat(t.Ulog) < 40).length;
        if (lowStakes >= 8) {
            earnedTrophies.add('oprezni_takmicar');
        }

        // Luzer
        if (user.UkupnoPoena <= 0) {
            earnedTrophies.add('luzer');
        }
        
        // Nizovi i povratnik
        let winStreak = 0;
        let lossStreak = 0;
        let foundPovratnik = false;

        for (let i = 0; i < finishedTickets.length; i++) {
            const ticket = finishedTickets[i];
            if (ticket.Status === 'Dobitan') {
                winStreak++;
                lossStreak = 0;
            } else if (ticket.Status === 'Gubitan') {
                lossStreak++;
                winStreak = 0;
            }

            if (winStreak >= 5) earnedTrophies.add('zlatna_serija');
            if (lossStreak >= 5) earnedTrophies.add('sruseni_snovi');
            
            // Provera za Povratnika
            if (!foundPovratnik && i >= 5) {
                const recentSix = finishedTickets.slice(i - 5, i + 1).map(t => t.Status);
                if (recentSix.slice(0, 3).every(s => s === 'Gubitan') && recentSix.slice(3, 6).every(s => s === 'Dobitan')) {
                    earnedTrophies.add('povratnik');
                    foundPovratnik = true;
                }
            }
        }

        return Array.from(earnedTrophies);
    }
    
    function renderTrophies(trophyIds, container) {
    if (!container) return;
    
    container.innerHTML = ''; // Očisti prethodni sadržaj
    
    if (!trophyIds || trophyIds.length === 0) {
        container.innerHTML = '<p class="text-zinc-500 text-sm w-full text-center">Nema osvojenih trofeja.</p>';
        return;
    }

    trophyIds.forEach(trophyId => {
        let definitionKey = trophyId;
        let displayName = '';

        if (typeof trophyId === 'string') {
            if (trophyId.startsWith('Šampion Sezone')) {
                definitionKey = 'sampion';
                displayName = trophyId;
            } else if (trophyId.startsWith('Vicešampion Sezone')) {
                definitionKey = 'vicesampion';
                displayName = trophyId;
            } else if (trophyId.startsWith('Bronza Sezone')) {
                definitionKey = 'bronza';
                displayName = trophyId;
            } else if (trophyId === 'Kralj kladionice') { // <-- DODAJTE OVAJ BLOK
                definitionKey = 'kralj_kladionice';
                displayName = trophyId;
            }
        }
        
        const definition = TROPHY_DEFINITIONS[definitionKey];

        if (definition) {
            const wrapper = document.createElement('div');
            wrapper.className = 'trophy-wrapper';
         if (definition.type === 'permanent') {
        wrapper.classList.add('trophy-permanent');
    }
    if (definitionKey === 'kralj_kladionice') {
        wrapper.classList.add('trophy-king');
    }
            
            const img = document.createElement('img');
            img.src = definition.img;
            img.alt = definition.name;
            img.className = 'trophy-icon';
            
            const tooltip = document.createElement('div');
            tooltip.className = 'trophy-tooltip';
            tooltip.innerHTML = `<span class="description">${definition.description}</span>`;
            
            const nameBelow = document.createElement('span');
            nameBelow.className = 'trophy-name-below';
            nameBelow.textContent = displayName || definition.name;

            wrapper.appendChild(img);
            wrapper.appendChild(tooltip);
            wrapper.appendChild(nameBelow);
            container.appendChild(wrapper);
        }
    });
}

    function calculateAndCacheStats() {
        if (!appCache.isDataLoaded) return;

        const usersWithStats = appCache.users.map(user => {
            const userTickets = appCache.tickets
                .filter(t => t.KorisnikID === user.KorisnikID)
                .sort((a, b) => new Date(a.Datum) - new Date(b.Datum));

            let correctBets = 0, incorrectBets = 0, pushVoidBets = 0;
            let totalStaked = 0, netProfitLoss = 0;
            let currentWinStreak = 0, maxWinStreak = 0;
            let currentLossStreak = 0, maxLossStreak = 0;

            let pointsAdjustment = 0;
            const totalStakedOnAllTickets = userTickets.reduce((sum, t) => sum + (parseFloat(t.Ulog) || 0), 0);

            userTickets.forEach(ticket => {
                const stake = parseFloat(ticket.Ulog) || 0;
                const odds = parseFloat(ticket.Kvota) || 1;
                
                if (ticket.Status === 'Aktivan') {
                    // Ne računaju se aktivni tiketi
                } else if (ticket.Status === 'Dobitan') {
                    correctBets++;
                    netProfitLoss += (stake * odds) - stake;
                    pointsAdjustment += (stake * odds);

                    currentWinStreak++;
                    currentLossStreak = 0;
                    if (currentWinStreak > maxWinStreak) maxWinStreak = currentWinStreak;

                } else if (ticket.Status === 'Gubitan') {
                    incorrectBets++;
                    netProfitLoss -= stake;
                    
                    currentLossStreak++;
                    currentWinStreak = 0;
                    if (currentLossStreak > maxLossStreak) maxLossStreak = currentLossStreak;

                } else if (ticket.Status === 'Poništen') {
                    pushVoidBets++;
                    pointsAdjustment += stake;
                }
                
                if (ticket.Status !== 'Aktivan') {
                    totalStaked += stake;
                }
            });
            
            const recalculatedTotalPoints = INITIAL_TOTAL_POINTS - totalStakedOnAllTickets + pointsAdjustment;

            const totalFinishedBets = correctBets + incorrectBets;
            const hitRate = totalFinishedBets > 0 ? ((correctBets / totalFinishedBets) * 100) : 0;
            const roi = totalStaked > 0 ? ((netProfitLoss / totalStaked) * 100) : 0;
            
            const seasonalTrophies = checkAllTrophiesForUser({ ...user, UkupnoPoena: recalculatedTotalPoints }, userTickets);

            return {
                ...user,
                UkupnoPoena: recalculatedTotalPoints,
                username: user.KorisnickoIme,
                country: user.Drzava,
                joinDate: user.DatumRegistracije,
                correctBets,
                incorrectBets,
                pushVoidBets,
                totalStaked,
                netProfitLoss: netProfitLoss.toFixed(2),
                hitRate: hitRate.toFixed(2) + '%',
                roi: roi.toFixed(2) + '%',
                totalFinishedBets,
                winStreak: maxWinStreak,
                lossStreak: maxLossStreak,
                seasonalTrophies: seasonalTrophies
            };
        });

        const isSeasonOver = currentSeasonInfo.isOffSeason && currentSeasonInfo.round >= 30;
        const MIN_TICKETS_FOR_RANKING = 10;

        usersWithStats.forEach(user => {
            user.isDisqualified = isSeasonOver && user.totalFinishedBets < MIN_TICKETS_FOR_RANKING;
        });

        const sortedUsers = usersWithStats.sort((a, b) => {
            if (a.isDisqualified && !b.isDisqualified) return 1;
            if (!a.isDisqualified && b.isDisqualified) return -1;
            return parseFloat(b.netProfitLoss) - parseFloat(a.netProfitLoss);
        });

        appCache.leaderboard = sortedUsers; 
        appCache.rankedLeaderboard = sortedUsers.filter(user => (user.correctBets > 0 || user.incorrectBets > 0) && !user.isDisqualified); 
        
        if (currentUser) {
            const updatedCurrentUser = usersWithStats.find(u => u.KorisnikID === currentUser.KorisnikID);
            if (updatedCurrentUser) {
                const originalPic = currentUser.ProfilnaSlika;
                currentUser = {...currentUser, ...updatedCurrentUser};
                if (originalPic) {
                    currentUser.ProfilnaSlika = originalPic;
                }
            }
        }
        
        const playersWithBets = usersWithStats.filter(u => u.correctBets > 0 || u.incorrectBets > 0);
        let totalRoiSum = 0;
        if (playersWithBets.length > 0) {
            playersWithBets.forEach(user => {
                totalRoiSum += parseFloat(user.roi);
            });
            const avgLeagueRoiValue = totalRoiSum / playersWithBets.length;
            appCache.leagueStats.avgLeagueRoi = avgLeagueRoiValue.toFixed(2) + '%';
        } else {
            appCache.leagueStats.avgLeagueRoi = '0.00%';
        }

        const topPerformer = appCache.rankedLeaderboard[0];
        const topPerformerProfit = topPerformer ? parseFloat(topPerformer.netProfitLoss) : 0;
        
        const ticketCounts = {};
        appCache.users.forEach(user => {
            const finishedTicketsCount = appCache.tickets.filter(t => t.KorisnikID === user.KorisnikID && t.Status !== 'Aktivan').length;
            ticketCounts[user.KorisnickoIme] = finishedTicketsCount;
        });

        let mostTicketsCount = 0;
        let mostActiveUsername = 'N/A';
        for (const username in ticketCounts) {
            if (ticketCounts[username] > mostTicketsCount) {
                mostTicketsCount = ticketCounts[username];
                mostActiveUsername = username;
            }
        }
        let mostActiveUserText = 'N/A';
        if (mostTicketsCount > 0) {
            mostActiveUserText = `${mostActiveUsername} (${mostTicketsCount} ${getTiketPlural(mostTicketsCount)})`;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let highestDailyWin = 0;
        let highestDailyWinner = 'N/A';
        let highestDailyWinTicket = null; 

        appCache.tickets.forEach(ticket => {
            const ticketDate = new Date(ticket.Datum);
            ticketDate.setHours(0, 0, 0, 0);

            if (ticket.Status === 'Dobitan' && ticketDate.getTime() === today.getTime()) {
                const profit = (parseFloat(ticket.Ulog) * parseFloat(ticket.Kvota)) - parseFloat(ticket.Ulog);
                if (profit > highestDailyWin) {
                    highestDailyWin = profit;
                    const winner = appCache.users.find(u => u.KorisnikID === ticket.KorisnikID);
                    highestDailyWinner = winner ? winner.KorisnickoIme : 'Nepoznat';
                    highestDailyWinTicket = ticket; 
                }
            }
        });
        const highestDailyWinText = highestDailyWin > 0 ? `${highestDailyWinner} (+${highestDailyWin.toFixed(2)} ${createCoinImg()})` : 'Nema dobitaka danas';

        const totalLeagueProfit = appCache.rankedLeaderboard.reduce((sum, user) => sum + parseFloat(user.netProfitLoss), 0);

        appCache.leagueStats = {
            totalBetsPlaced: appCache.tickets.filter(t => t.Status !== 'Aktivan').length,
            totalLeagueProfit: totalLeagueProfit,
            avgLeagueRoi: appCache.leagueStats.avgLeagueRoi,
            topPerformerUser: topPerformer ? `${topPerformer.username} (${(topPerformerProfit > 0 ? '+' : '')}${topPerformer.netProfitLoss} ${createCoinImg()})` : 'N/A',
            mostActiveUser: mostActiveUserText,
            highestDailyWin: highestDailyWinText,
            highestDailyWinTicket: highestDailyWinTicket 
        };
    }


    // --- AUTENTIFIKACIJA I UPRAVLJANJE KORISNIKOM ---
    function checkLoginStatus() {
        const userJson = localStorage.getItem('kockariUser');
        if (userJson) {
            currentUser = JSON.parse(userJson);
        } else {
            updateAuthUI(false);
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = 'Prijavljivanje...';
        
        const emailOrUsername = document.getElementById('loginEmailUsername').value;
        const password = document.getElementById('loginPassword').value;
        
        try {
            const result = await callGAS('loginUser', { emailOrUsername, password });
            
            currentUser = result.user;
            localStorage.setItem('kockariUser', JSON.stringify(currentUser));
            
            await fetchAndCacheAllData(); 
            
            closeModal(document.getElementById('loginModal'));
            showToast('Uspešno ste se prijavili!', 'success');
            e.target.reset();
        } catch (error) {
            console.error("Prijava nije uspela:", error);
        } finally {
            btn.disabled = false; btn.innerHTML = originalText;
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.innerHTML;
        
        const email = document.getElementById('registerEmail').value;
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;
        const confirmPassword = document.getElementById('registerPasswordConfirm').value;
        const country = document.getElementById('registerCountry').value;

        if (password !== confirmPassword) {
            showToast('Lozinke se ne podudaraju.', 'error');
            return;
        }
        if (username.length > 14) {
            showToast('Korisničko ime ne sme biti duže od 14 karaktera.', 'error');
            return;
        }
        if (username.length < 4) {
        showToast('Korisničko ime mora imati najmanje 4 karaktera.', 'error');
        return;
    }
        
        btn.disabled = true; btn.innerHTML = 'Registrovanje...';
        try {
            await callGAS('registerUser', { email, username, password, country });
            
            closeModal(document.getElementById('registerModal'));
            document.getElementById('verifyEmailDisplay').textContent = email;
            openModal(document.getElementById('verifyModal'));
            showToast('Korisnik uspešno registrovan. Proverite email za verifikacioni kod.', 'success');
            e.target.reset();

        } catch (error) {
            console.error("Registracija nije uspela:", error);
        } finally {
            btn.disabled = false; btn.innerHTML = originalText;
        }
    }

    async function handleVerify(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.disabled = true; btn.innerHTML = 'Proveravanje...';
        
        const code = document.getElementById('verifyCode').value;
        const email = document.getElementById('verifyEmailDisplay').textContent;

        try {
            await callGAS('verifyUser', { email, code });
            
            await fetchAndCacheAllData();
            closeModal(document.getElementById('verifyModal'));
            showToast('Nalog uspešno verifikovan. Možete se prijaviti.', 'success');
            openModal(document.getElementById('loginModal'));
            e.target.reset();

        } catch (error) {
            console.error("Verifikacija nije uspela:", error);
        } finally {
            btn.disabled = false; btn.innerHTML = 'Potvrdi';
        }
    }

    function showConfirmation(title, message, onConfirm) {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalMessage').innerHTML = message;

        const confirmBtn = document.getElementById('confirmModalConfirm');
        const cancelBtn = document.getElementById('confirmModalCancel');

        const confirmHandler = () => {
            closeModal(confirmModal);
            onConfirm();
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
        };
        const cancelHandler = () => closeModal(confirmModal);

        confirmBtn.addEventListener('click', confirmHandler, { once: true });
        cancelBtn.addEventListener('click', cancelHandler, { once: true });

        openModal(confirmModal);
    }

    async function handleLogout() {
        showConfirmation(
            "Odjava", 
            "Da li ste sigurni da želite da se odjavite?", 
            () => {
                currentUser = null;
                localStorage.removeItem('kockariUser');
                showToast('Uspešno ste se odjavili.', 'info');
                
                [myProfileModal, myTicketsModal, achievementsModal, settingsModal].forEach(modal => closeModal(modal));
                
                updateAuthUI(false);
                renderLeaderboard();
            }
        );
    }
   
    async function handleChangeEmail(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Menjam...';

        const newEmail = document.getElementById('newEmailInput').value;
        const currentPassword = document.getElementById('currentPasswordEmail').value;

        try {
            const result = await callGAS('changeEmail', {
                userId: currentUser.KorisnikID,
                newEmail,
                currentPassword
            });

            currentUser.Email = result.newEmail;
            localStorage.setItem('kockariUser', JSON.stringify(currentUser));
            
            showToast(result.message, 'success');
            e.target.reset();
            closeModal(settingsModal);

        } catch (error) {
            console.error("Promena email-a nije uspela:", error);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    async function handleChangePassword(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Menjam...';

        const currentPassword = document.getElementById('currentPasswordPassword').value;
        const newPassword = document.getElementById('newPasswordInput').value;
        const confirmNewPassword = document.getElementById('confirmNewPasswordInput').value;

        if (newPassword !== confirmNewPassword) {
            showToast('Nove lozinke se ne podudaraju.', 'error');
            btn.disabled = false;
            btn.innerHTML = originalText;
            return;
        }
        
        if (newPassword.length < 6) {
            showToast('Nova lozinka mora imati najmanje 6 karaktera.', 'error');
            btn.disabled = false;
            btn.innerHTML = originalText;
            return;
        }

        try {
            const result = await callGAS('changePassword', {
                userId: currentUser.KorisnikID,
                currentPassword,
                newPassword
            });

            showToast(result.message, 'success');
            e.target.reset();
            closeModal(settingsModal);

        } catch (error) {
            console.error("Promena lozinke nije uspela:", error);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // --- RESET LOZINKE ---
    function handleForgotPasswordRequest(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmailUsername').value;
        if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
            showToast('Molimo unesite ispravnu email adresu u polje za prijavu.', 'error');
            return;
        }
        document.getElementById('confirmResetEmailDisplay').textContent = email;
        closeModal(document.getElementById('loginModal'));
        openModal(confirmPasswordResetModal);
    }

    async function handleSendResetLink() {
        const email = document.getElementById('confirmResetEmailDisplay').textContent;
        const btn = document.getElementById('confirmReset');
        const originalText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = 'Slanje...';

        try {
            await callGAS('sendPasswordResetLink', { email });
            showToast('Link za resetovanje lozinke je poslat. Proverite Vaš email.', 'success');
            closeModal(confirmPasswordResetModal);
        } catch (error) {
            console.error('Slanje linka nije uspelo:', error);
        } finally {
            btn.disabled = false; btn.innerHTML = 'Pošalji link';
        }
    }

    async function handleResetPassword(e) {
        e.preventDefault();
        const newPassword = document.getElementById('resetNewPassword').value;
        const confirmPassword = document.getElementById('resetConfirmPassword').value;
        const token = document.getElementById('resetTokenInput').value;
        
        if (newPassword !== confirmPassword) {
            showToast('Lozinke se ne podudaraju.', 'error');
            return;
        }
        if (newPassword.length < 6) {
            showToast('Lozinka mora imati najmanje 6 karaktera.', 'error');
            return;
        }

        const btn = document.getElementById('submitResetPassword');
        const originalText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = 'Čuvanje...';

        try {
            await callGAS('resetPassword', { token, newPassword });
            showToast('Lozinka je uspešno promenjena! Sada se možete prijaviti.', 'success');
            
            setTimeout(() => {
                closeModal(resetPasswordModal);
                openModal(document.getElementById('loginModal'));
                window.history.replaceState({}, document.title, window.location.pathname);
            }, 2000);

        } catch (error) {
            console.error('Resetovanje lozinke nije uspelo:', error);
            btn.disabled = false;
            btn.innerHTML = originalText;
        } 
    }

    // --- RENDEROVANJE KORISNIČKOG INTERFEJSA ---
    function updateAuthUI(isLoggedIn) {
        if (isLoggedIn && currentUser) {
            const dailyUsed = getCurrentDailyPointsUsed();
            authButtons.classList.add('hidden');
            loggedInProfile.classList.remove('hidden');
            
            profilePic.src = getUserDisplayImage(currentUser);
            
            profileUsername.textContent = currentUser.KorisnickoIme;
            userTotalPoints.innerHTML = `<span>${parseFloat(currentUser.UkupnoPoena).toFixed(2)}</span> ${createCoinImg()}`;
            userDailyPoints.innerHTML = `<span>${(DAILY_POINT_LIMIT - dailyUsed)}</span> ${createCoinImg()}`;
        } else {
            authButtons.classList.remove('hidden');
            loggedInProfile.classList.add('hidden');
        }
        updateMobileHeader(isLoggedIn);
        lucide.createIcons();
    }

    function updateMobileHeader(isLoggedIn) {
        mobileProfileArea.innerHTML = ''; 
        if (isLoggedIn && currentUser) {
            const dailyUsed = getCurrentDailyPointsUsed();
            mobileProfileArea.innerHTML = 
                `<div class="flex items-center gap-2 flex-shrink-0">
                    <div class="text-right">
                        <div class="text-xs text-zinc-300 flex items-center justify-end">Uk: <span class="font-semibold text-white ml-1">${parseFloat(currentUser.UkupnoPoena).toFixed(2)}</span>${createCoinImg()}</div>
                        <div class="text-xs text-zinc-400 flex items-center justify-end">Dn: <span class="font-semibold text-white ml-1">${(DAILY_POINT_LIMIT - dailyUsed)}</span>${createCoinImg()}</div>
                    </div>
                    <button id="mobileProfileButton"><img src="${getUserDisplayImage(currentUser)}" alt="Profil" class="w-10 h-10 rounded-full border-2 border-amber-400 object-cover"></button>
                </div>`;
            document.getElementById('mobileProfileButton').addEventListener('click', showMyProfile);
        } else {
    mobileProfileArea.innerHTML =
        `<button id="mobileGuestButton" class="p-2 rounded-full bg-slate-700 hover:bg-slate-600 transition-colors"><i data-lucide="user-circle-2" class="w-6 h-6 text-white"></i></button>
        <div id="mobile-auth-dropdown" class="mobile-profile-dropdown hidden" style="width: 200px;">
            <div class="p-3 space-y-3">
                <button id="mobileLoginButton" class="custom-button bg-zinc-700 border border-zinc-600 hover:bg-zinc-600 w-full text-sm font-semibold">
                    <i data-lucide="log-in" class="w-4 h-4"></i>
                    <span>Prijavi se</span>
                </button>
                <button id="mobileRegisterButton" class="custom-button gradient-button w-full text-sm font-bold">
                    <i data-lucide="user-plus" class="w-4 h-4"></i>
                    <span>Registruj se</span>
                </button>
            </div>
        </div>`;

    const dropdown = document.getElementById('mobile-auth-dropdown');
    document.getElementById('mobileGuestButton').addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('hidden');
    });
    document.getElementById('mobileLoginButton').addEventListener('click', () => {
        dropdown.classList.add('hidden');
        openModal(document.getElementById('loginModal'));
    });
    document.getElementById('mobileRegisterButton').addEventListener('click', () => {
        dropdown.classList.add('hidden');
        openModal(document.getElementById('registerModal'));
    });
    document.addEventListener('click', (e) => {
        if (!mobileProfileArea.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });
}
        lucide.createIcons();
    }

   function renderLeaderboard() {
    if (!appCache.isDataLoaded) return;

    const data = appCache.leaderboard || [];

    const desktopTbody = document.querySelector('#leaderboard-container-desktop tbody');
    const mobileTbody = document.querySelector('#mobile-leaderboard-tbody');

    desktopTbody.innerHTML = '';
    mobileTbody.innerHTML = '';

    if (data.length === 0) {
        const emptyHtml = '<tr><td colspan="8" class="text-center p-8">Nema rangiranih takmičara.</td></tr>';
        desktopTbody.innerHTML = emptyHtml;
        mobileTbody.innerHTML = emptyHtml;
        return;
    }

    data.forEach((user, index) => {
        const rankIndex = appCache.rankedLeaderboard.findIndex(u => u.KorisnikID === user.KorisnikID);
        const rank = rankIndex !== -1 ? rankIndex + 1 : null;
        
        const profit = parseFloat(user.netProfitLoss);
        const profitClass = profit > 0 ? 'profit-positive' : profit < 0 ? 'profit-negative' : 'profit-neutral';
        const roi = parseFloat(user.roi);
        const roiClass = roi > 0 ? 'profit-positive' : roi < 0 ? 'profit-negative' : 'profit-neutral';

        const rowClasses = [];
        if (user.isDisqualified) {
            rowClasses.push('bg-red-900/50', 'hover:bg-red-800/60');
        } else if (rank && rank <= 3) {
            rowClasses.push(`rank-${rank}`);
        }

        if (currentUser && currentUser.KorisnickoIme === user.username) {
            rowClasses.push('logged-in-user');
        }

        let rankIcon = '';
        let rankContentDesktop, rankContentMobile;

        if (user.isDisqualified) {
            rankContentDesktop = `<td class="py-1 px-3"><span class="text-xs text-red-400">DSQ</span></td>`;
            rankContentMobile = `<td class="p-2"><div class="flex items-center justify-center"><span class="text-xs text-red-400">DSQ</span></div></td>`;
        } else if (rank) {
            if (rank === 1) rankIcon = '<i data-lucide="trophy" class="w-3.5 h-3.5 text-amber-400"></i>';
            else if (rank === 2) rankIcon = '<i data-lucide="trophy" class="w-3.5 h-3.5 text-slate-300"></i>';
            else if (rank === 3) rankIcon = '<i data-lucide="trophy" class="w-3.5 h-3.5 text-yellow-700"></i>';
            rankContentDesktop = `<td class="py-1 px-3 text-zinc-100 font-bold flex items-center gap-2 text-sm">${rank} ${rankIcon}</td>`;
            // --- IZMENA ZA PORAVNANJE NA MOBILNOM ---
            rankContentMobile = `<td class="p-2"><div class="text-zinc-100 font-bold flex items-center justify-center gap-1"><span class="w-6 text-center">${rank || ''}</span><span class="w-4">${rankIcon}</span></div></td>`;
        } else {
             rankContentDesktop = `<td class="py-1 px-3"></td>`;
             rankContentMobile = `<td class="p-2"></td>`;
        }

        const desktopRow = document.createElement('tr');
        desktopRow.dataset.username = user.username.toLowerCase();
        desktopRow.className = rowClasses.join(' ');

        desktopRow.innerHTML =
            `${rankContentDesktop}
            <td class="py-1 px-3 text-sm font-semibold text-sky-400"><span class="hover:underline cursor-pointer" onclick="showUserHistory('${user.username}')">${user.username}</span><span class="country-abbr">${getCountryAbbreviation(user.country)}</span></td>
            <td class="py-1 px-3 text-center text-sm font-bold">${user.correctBets}</td>
            <td class="py-1 px-3 text-center text-sm font-bold">${user.incorrectBets}</td>
            <td class="py-1 px-3 text-center text-sm font-bold">${user.pushVoidBets}</td>
            <td class="py-1 px-3 text-center text-sm font-bold">${user.hitRate}</td>
            <td class="py-1 px-3 text-center text-sm font-bold ${roiClass}">${user.roi}</td>
            <td class="py-1 px-3 text-center text-sm font-bold ${profitClass} flex items-center justify-center">${(profit > 0 ? '+' : '')}${user.netProfitLoss} ${createCoinImg()}</td>`;
        desktopTbody.appendChild(desktopRow);

        const mobileRow = document.createElement('tr');
        mobileRow.className = rowClasses.join(' ');
        mobileRow.innerHTML =
            `${rankContentMobile}
            <td class="p-2 text-sky-400 truncate"><span class="hover:underline cursor-pointer" onclick="showUserHistory('${user.username}', 'tabelaModal')">${user.username}</span></td>
            <td class="p-2 text-center font-bold ${profitClass}"><div class="flex items-center justify-center">${(profit > 0 ? '+' : '')}${user.netProfitLoss}${createCoinImg()}</div></td>
            <td class="extended-col p-2 text-center">${user.correctBets}</td>
            <td class="extended-col p-2 text-center">${user.incorrectBets}</td>
            <td class="extended-col p-2 text-center">${user.pushVoidBets}</td>
            <td class="extended-col p-2 text-center">${user.hitRate}</td>
            <td class="extended-col p-2 text-center ${roiClass}">${user.roi}</td>`;
        mobileTbody.appendChild(mobileRow);
    });
    
    lucide.createIcons();
}

    function renderLeagueStats() {
        if (!appCache.isDataLoaded || !appCache.leagueStats) return;
        const stats = appCache.leagueStats;
        const desktopContainer = document.getElementById('leagueStatsContainer');
        const modalContainer = document.getElementById('leagueStatsContainerModal');
        
        const makeUsernameClickable = (text, modalOrigin) => {
            if (!text || typeof text !== 'string') return 'N/A';
            const userMatch = text.match(/^(.+?)\s*\(/);
            const username = userMatch ? userMatch[1].trim() : text.trim();
            if (appCache.users.some(u => u.KorisnickoIme === username)) {
                const restOfText = text.substring(username.length);
                return `<span class="hover:underline cursor-pointer" onclick="event.stopPropagation(); showUserHistory('${username}', '${modalOrigin}')">${username}</span>${restOfText}`;
            }
            return text;
        };
        
        const totalProfit = stats.totalLeagueProfit || 0;
        
        const generateStatsHTML = (modalOrigin) => {
            const dailyWinTicketData = stats.highestDailyWinTicket ? `data-ticket-data='${JSON.stringify(stats.highestDailyWinTicket)}'` : '';
            return `<div class="space-y-3">
                <div class="flex items-start"><i data-lucide="layers" class="w-5 h-5 mr-3 text-orange-500 flex-shrink-0 mt-0.5"></i><div class="flex-grow flex flex-wrap items-baseline"><span class="text-white mr-2">Ukupno opklada:</span><span class="font-semibold text-blue-400">${(stats.totalBetsPlaced || 0)}</span></div></div>
                <div class="flex items-start"><i data-lucide="banknote" class="w-5 h-5 mr-3 text-orange-500 flex-shrink-0 mt-0.5"></i><div class="flex-grow flex flex-wrap items-baseline"><span class="text-white mr-2">Ukupni profit lige:</span><span class="font-semibold text-blue-400 flex items-center">${(totalProfit > 0 ? '+' : '')}${totalProfit.toFixed(2)} ${createCoinImg()}</span></div></div>
                <div class="flex items-start"><i data-lucide="percent" class="w-5 h-5 mr-3 text-orange-500 flex-shrink-0 mt-0.5"></i><div class="flex-grow flex flex-wrap items-baseline"><span class="text-white mr-2">Prosečni ROI Lige:</span><span class="font-semibold text-blue-400">${(stats.avgLeagueRoi || '0.00%')}</span></div></div>
                <div class="flex items-start"><i data-lucide="crown" class="w-5 h-5 mr-3 text-orange-500 flex-shrink-0 mt-0.5"></i><div class="flex-grow flex flex-wrap items-baseline"><span class="text-white mr-2">Najbolji učesnik:</span><span class="font-semibold text-blue-400">${(makeUsernameClickable(stats.topPerformerUser, modalOrigin) || 'N/A')}</span></div></div>
                <div class="flex items-start"><i data-lucide="gem" class="w-5 h-5 mr-3 text-orange-500 flex-shrink-0 mt-0.5"></i><div class="flex-grow flex flex-wrap items-baseline"><span class="text-white mr-2">Najveći dnevni dobitak:</span><span class="font-semibold text-blue-400 inline-flex items-center gap-1" ${dailyWinTicketData} onmouseenter="showDailyWinPopover(event)" onmouseleave="hideDailyWinPopover()">${(stats.highestDailyWin || 'N/A')}</span></div></div>
                <div class="flex items-start"><i data-lucide="flame" class="w-5 h-5 mr-3 text-orange-500 flex-shrink-0 mt-0.5"></i><div class="flex-grow flex flex-wrap items-baseline"><span class="text-white mr-2">Najaktivniji:</span><span class="font-semibold text-blue-400">${(makeUsernameClickable(stats.mostActiveUser, modalOrigin) || 'N/A')}</span></div></div>
            </div>`;
        }

        desktopContainer.innerHTML = generateStatsHTML(null).replace('<div class="space-y-3">', '<div class="space-y-3 text-sm">');
        modalContainer.innerHTML = generateStatsHTML('statistikaLigeModal').replace('<div class="space-y-3">', '<div class="space-y-3 text-base">');
        lucide.createIcons();
    }

    function updateDailyPointsDisplay() {
        if (currentUser) {
            const stake = parseInt(stakeInput.value) || 0;
            const dailyUsed = getCurrentDailyPointsUsed();
            const dailyRemaining = DAILY_POINT_LIMIT - dailyUsed;
            remainingPointsValue.innerHTML = `${Math.max(0, dailyRemaining - stake)} ${createCoinImg()}`;
        }
    }
    
    function generateTicketPopoverHTML(ticket) {
    // --- START: Logika za različite veličine na Desktopu i Telefonu ---
    const isDesktop = window.innerWidth >= 1024;
    
    // Veličina gornje trake (statusa) - veća samo na desktopu
    const headerPadding = isDesktop ? 'py-2' : 'py-1.5';
    const headerFontSize = isDesktop ? 'text-sm' : 'text-xs';

    // Veličina slova u listi parova - veća samo na desktopu
    const timeFontSize = isDesktop ? 'text-[12px]' : 'text-[10px]';
    const mainFontSize = isDesktop ? 'text-[14px]' : 'text-[11px]';

    // Veličina slova u donjem delu (Ulog, Kvota, Dobitak) - veća samo na desktopu
    const summaryFontSize = isDesktop ? 'text-[13px]' : 'text-[10px]';
    // --- END: Logika za veličine ---

    const statusMap = { 'Dobitan': 'bg-green-600', 'Gubitan': 'bg-red-600', 'Poništen': 'bg-yellow-500', 'Aktivan': 'bg-blue-600' };
    const statusClass = statusMap[ticket.Status] || 'bg-gray-500';
    const stake = parseFloat(ticket.Ulog);
    const totalOdds = parseFloat(ticket.Kvota) || 1;

    let winningsText, winningsClass, winningsLabel;
    let processingMessage = '';
    let isProcessing = ticket.Status === 'Aktivan' && totalOdds === 1;

    if (isProcessing) {
         processingMessage = `<div class="text-center text-xs text-amber-400 py-1 bg-amber-900/50">Proverava se tiket..</div>`;
    }

    if (ticket.Status === 'Dobitan') {
        winningsLabel = 'Dobitak';
        winningsText = `+${(stake * totalOdds).toFixed(2)}`;
        winningsClass = 'text-green-400';
    } else if (ticket.Status === 'Gubitan') {
        winningsLabel = 'Dobitak';
        winningsText = '0.00';
        winningsClass = 'text-red-400';
    } else if (ticket.Status === 'Poništen') {
        winningsLabel = 'Povrat';
        winningsText = `+${stake.toFixed(2)}`;
        winningsClass = 'text-yellow-400';
    } else { // Aktivan
        winningsLabel = 'Pot. Dobitak';
        winningsText = `+${(stake * totalOdds).toFixed(2)}`;
        winningsClass = 'text-blue-400';
    }

    let pairsHtml = '';
    const parovi = Array.isArray(ticket.Parovi) ? ticket.Parovi : [];
    const tipovi = Array.isArray(ticket.Tipovi) ? ticket.Tipovi : [];
    const kvote = Array.isArray(ticket.Kvote) ? ticket.Kvote : [];
    const vremena = Array.isArray(ticket.Vreme) ? ticket.Vreme : [];
    const rezultati = Array.isArray(ticket.Rezultati) ? ticket.Rezultati : [];
    const statusiParova = Array.isArray(ticket.StatusParova) ? ticket.StatusParova : [];

    for (let i = 0; i < parovi.length; i++) {
        const vreme = vremena[i] || '';
        const par = parovi[i] || 'N/A';
        const tip = tipovi[i] ? `Tip: ${tipovi[i]}` : '';
        const kvota = parseFloat(kvote[i]) || 0;
        const rezultat = rezultati[i] || '';
        const statusPara = statusiParova[i] || '';
        
        let kvotaClass = 'text-zinc-200';
        if (statusPara === 'D') kvotaClass = 'text-green-400';
        else if (statusPara === 'G') kvotaClass = 'text-red-400';
        else if (statusPara === 'P') kvotaClass = 'text-yellow-400';

        pairsHtml += `
             <div class="grid grid-cols-[auto_1fr_auto_auto] gap-x-2 items-center py-1.5 border-b border-zinc-700/50 last:border-b-0">
            <div class="text-zinc-400 ${timeFontSize} self-start pt-0.5">${vreme}</div>
            <div class="flex flex-col pl-1">
                <span class="text-zinc-200 font-medium ${mainFontSize} leading-tight">${par}</span>
                <span class="text-amber-400 font-semibold ${mainFontSize} leading-tight mt-0.5">${tip}</span>
            </div>
            <div class="text-left font-semibold ${mainFontSize} leading-tight w-[34px] ${kvotaClass}">${kvota.toFixed(2)}</div>
            <div class="text-left font-semibold ${mainFontSize} leading-tight w-[34px] text-zinc-200">${rezultat}</div>
        </div>
        `;
    }
    if (parovi.length === 0) {
        pairsHtml = `<p class="text-zinc-400 text-center py-4 text-xs">Nema parova na tiketu.</p>`;
    }

    const ticketBody = `
        <div class="p-1.5">
            <div class="space-y-0 text-zinc-300 mb-2">${pairsHtml}</div>
            <div class="grid grid-cols-3 gap-2 text-center ${summaryFontSize} mt-2 pt-1.5 border-t border-zinc-700">
                <div><span class="block text-zinc-400">Ulog</span><span class="block font-bold text-white flex items-center justify-center">${stake.toFixed(2)} ${createCoinImg()}</span></div>
                <div><span class="block text-zinc-400">Uk. Kvota</span><span class="block font-bold text-white">${totalOdds.toFixed(2)}</span></div>
                <div><span class="block text-zinc-400">${winningsLabel}</span><span class="block font-bold ${winningsClass} flex items-center justify-center">${winningsText} ${createCoinImg()}</span></div>
            </div>
        </div>
    `;

    return (
        `<div class="popover-content-wrapper">
            <div class="overflow-hidden rounded-lg shadow-md border border-zinc-700 bg-zinc-900/90 backdrop-blur-sm">
                <div class="${statusClass} text-white font-bold text-center ${headerPadding} ${headerFontSize} flex justify-between px-3">
                    <span>${ticket.Status}</span>
                    <span>${formatDate(ticket.Datum, true)}</span>
                </div>
                ${processingMessage}
                <div class="${isProcessing ? 'ticket-body-processing' : ''}">
                    ${ticketBody}
                </div>
            </div>
        </div>`
    );
}
    
    let popoverHideTimeout;
    function showCentralPopover(event) {
        clearTimeout(popoverHideTimeout);
        const popover = document.getElementById('centralTicketPopover');
        const ticket = JSON.parse(event.currentTarget.dataset.ticketData);

        // Mobile-specific logic
        if (window.innerWidth < 1024) {
             if (popover.classList.contains('show') && popover.innerHTML !== '') {
                popover.classList.remove('show');
                setTimeout(() => {
                    popover.innerHTML = generateTicketPopoverHTML(ticket);
                    lucide.createIcons();
                    popover.classList.add('show');
                }, 150);
             } else {
                popover.innerHTML = generateTicketPopoverHTML(ticket);
                lucide.createIcons();
                popover.classList.add('show');
             }
             return;
        }

        // Desktop logic
        const contentWrapper = popover.querySelector('.popover-content-wrapper');
        if (popover.classList.contains('show') && contentWrapper) {
            contentWrapper.style.opacity = 0;
            setTimeout(() => {
                popover.innerHTML = generateTicketPopoverHTML(ticket);
                lucide.createIcons();
                const newContentWrapper = popover.querySelector('.popover-content-wrapper');
                newContentWrapper.style.opacity = 0;
                requestAnimationFrame(() => {
                    newContentWrapper.style.opacity = 1;
                });
            }, 150);
        } else {
            popover.innerHTML = generateTicketPopoverHTML(ticket);
            lucide.createIcons();
            const container = document.getElementById('bettingOutcomesCircles');
            const modalContent = userHistoryModal.querySelector('.modal-content');
            const containerRect = container.getBoundingClientRect();
            const modalRect = modalContent.getBoundingClientRect();

            // --- POČETAK ISPRAVKE ---
            // Fiksna širina popover-a za desktop iz CSS-a je 440px
            const popoverWidth = 440;
            const popoverHalfWidth = popoverWidth / 2;
            const modalWidth = modalRect.width;

            // Izračunaj početnu idealnu poziciju (centar "outcome" kružića)
            let left = containerRect.left + containerRect.width / 2 - modalRect.left;

            // Ograniči 'left' vrednost da popover ne bi izašao van modala
            // Ne dozvoli da leva ivica popover-a ode previše levo
            left = Math.max(popoverHalfWidth + 8, left); // +8px za mali razmak od ivice
            
            // Ne dozvoli da desna ivica popover-a ode previše desno
            left = Math.min(modalWidth - popoverHalfWidth - 8, left); // -8px za mali razmak od ivice
            // --- KRAJ ISPRAVKE ---

            const top = containerRect.top - modalRect.top;
            popover.style.left = `${left}px`;
            popover.style.top = `${top}px`;
            popover.classList.add('show');
        }
    }

    function hideCentralPopover() {
        const popover = document.getElementById('centralTicketPopover');
        popoverHideTimeout = setTimeout(() => {
            popover.classList.remove('show');
        }, 100);
    }
    
    let dailyWinPopoverTimeout;
    function showDailyWinPopover(event) {
        const target = event.currentTarget;
        const ticketData = target.dataset.ticketData;
        if (!ticketData) return;

        event.stopPropagation();
        clearTimeout(dailyWinPopoverTimeout);

        const popover = document.getElementById('dailyWinPopover');
        if (!popover) return;

        const ticket = JSON.parse(ticketData);
        popover.innerHTML = generateTicketPopoverHTML(ticket);
        lucide.createIcons();

        const isSmallScreen = window.innerWidth < 1024;

        if (isSmallScreen) {
            // Logika za prikaz na sredini kartice "Statistika lige"
            const cardElement = event.currentTarget.closest('.card, .modal-content');
            if (!cardElement) return; // Ako ne nađe karticu, neće uraditi ništa

            document.body.appendChild(popover);
            popover.style.position = 'fixed'; // Koristi 'fixed' da bi ignorisalo skrolovanje

            const cardRect = cardElement.getBoundingClientRect();
            // Računa centar kartice
            const centerX = cardRect.left + cardRect.width / 2;
            const centerY = cardRect.top + cardRect.height / 2;

            // Postavlja tiket na izračunati centar
            popover.style.left = `${centerX}px`;
            popover.style.top = `${centerY}px`;
            popover.style.transform = 'translate(-50%, -50%)'; // Fina korekcija za centriranje

            popover.classList.add('show');

            // Logika za zatvaranje tiketa klikom van njega
            setTimeout(() => { // setTimeout da ne bi uhvatio isti klik koji je otvorio tiket
                const closeHandler = (e) => {
                    if (!popover.contains(e.target) && !target.contains(e.target)) {
                        popover.classList.remove('show');
                        window.removeEventListener('click', closeHandler);
                    }
                };
                window.addEventListener('click', closeHandler);
            }, 0);

        } else {
            // NORMALNA DESKTOP VERZIJA - OSTAJE NETAKNUTA
            document.body.appendChild(popover);
            const targetRect = target.getBoundingClientRect();
            popover.style.position = 'absolute';
            popover.style.left = `${targetRect.left + targetRect.width / 2}px`;
            popover.style.top = `${targetRect.top}px`;
            popover.style.transform = 'translateX(-50%) translateY(-100%) translateY(-10px)';
            popover.classList.add('show');
        }
    }

    function hideDailyWinPopover() {
        const popover = document.getElementById('dailyWinPopover');
        dailyWinPopoverTimeout = setTimeout(() => {
            popover.classList.remove('show');
        }, 100);
    }

    function renderInstagramPosts() {
        const settings = appCache.settings;
        const containers = document.querySelectorAll('.instagram-posts-container');
        
        if (containers.length === 0) return;

        containers.forEach(container => {
            if (!container || !settings || !settings.instagramPosts) {
                if(container) container.innerHTML = '<div class="p-8 text-white text-center flex items-center justify-center h-full"><span>Nema objava za prikaz.</span></div>';
                return;
            }
    
            const postUrls = settings.instagramPosts.filter(url => url && url.trim() !== '');
    
            if (postUrls.length === 0) {
                container.innerHTML = '<div class="p-8 text-white text-center flex items-center justify-center h-full"><span>Nema objava za prikaz.</span></div>';
                return;
            }
            
            container.innerHTML = ''; 
    
            postUrls.forEach((url, index) => {
                const postWrapper = document.createElement('div');
                postWrapper.className = 'instagram-post-wrapper';
                if (index === 0) {
                    postWrapper.classList.add('active');
                }
    
                const blockquote = document.createElement('blockquote');
                blockquote.className = 'instagram-media';
                blockquote.setAttribute('data-instgrm-permalink', url);
                blockquote.setAttribute('data-instgrm-version', '14');
    
                postWrapper.appendChild(blockquote);
                container.appendChild(postWrapper);
            });
    
            let currentIndex = 0;
            const posts = container.querySelectorAll('.instagram-post-wrapper');
    
            if (posts.length > 1) {
                if (container.querySelector('.instagram-nav-btn.prev')) return;

                const prevBtn = document.createElement('button');
                prevBtn.className = 'instagram-nav-btn prev absolute top-1/2 left-2 -translate-y-1/2 bg-black/40 hover:bg-black/60 text-white rounded-full p-1 z-10 transition-colors';
                prevBtn.innerHTML = '<i data-lucide="chevron-left" class="w-6 h-6"></i>';
                
                const nextBtn = document.createElement('button');
                nextBtn.className = 'instagram-nav-btn next absolute top-1/2 right-2 -translate-y-1/2 bg-black/40 hover:bg-black/60 text-white rounded-full p-1 z-10 transition-colors';
                nextBtn.innerHTML = '<i data-lucide="chevron-right" class="w-6 h-6"></i>';
    
                container.appendChild(prevBtn);
                container.appendChild(nextBtn);
                
                function showPost(index) {
                    posts.forEach((post, i) => {
                        post.classList.toggle('active', i === index);
                    });
                }
    
                nextBtn.addEventListener('click', () => {
                    currentIndex = (currentIndex + 1) % posts.length;
                    showPost(currentIndex);
                    if (window.instgrm) window.instgrm.Embeds.process();
                });
    
                prevBtn.addEventListener('click', () => {
                    currentIndex = (currentIndex - 1 + posts.length) % posts.length;
                    showPost(currentIndex);
                    if (window.instgrm) window.instgrm.Embeds.process();
                });
            }
        });
        
        if (!window.instgrm) {
            const script = document.createElement('script');
            script.src = 'https://www.instagram.com/embed.js';
            script.async = true;
            script.onload = () => {
                if(window.instgrm) window.instgrm.Embeds.process();
            };
            document.body.appendChild(script);
        } else {
             if(window.instgrm) window.instgrm.Embeds.process();
        }

        lucide.createIcons();
    }


    // --- FUNKCIJE ZA SADRŽAJ MODALA (INSTANT) ---
    function getStyledRankHTML(rank) {
        if (!rank) {
            return `<div class="rank-display-wrapper unranked" title="Korisnik nije ispunio uslove za rangiranje.">Nije rangiran</div>`;
        }

        if (rank === 1) {
            return `<div class="rank-display-wrapper rank-1"><i data-lucide="trophy"></i><span>#${rank}</span></div>`;
        }
        if (rank === 2) {
            return `<div class="rank-display-wrapper rank-2"><i data-lucide="medal"></i><span>#${rank}</span></div>`;
        }
        if (rank === 3) {
            return `<div class="rank-display-wrapper rank-3"><i data-lucide="award"></i><span>#${rank}</span></div>`;
        }
        return `<div class="rank-display-wrapper rank-other">#${rank}</div>`;
    }

    function showUserHistory(username, openedFrom = null) {
        if (!appCache.isDataLoaded) return;
        const user = appCache.leaderboard.find(u => u.username === username);
        if (!user) {
            showToast('Korisnik nije pronađen.', 'error');
            return;
        }

        if (openedFrom) {
            userHistoryModal.dataset.openedFrom = openedFrom;
            userHistoryBackButton.classList.remove('hidden');
            closeModal(document.getElementById(openedFrom));
        } else {
            delete userHistoryModal.dataset.openedFrom;
            userHistoryBackButton.classList.add('hidden');
        }

        document.getElementById('modalUserName').textContent = user.username;
        document.getElementById('modalUserPic').src = getUserDisplayImage(user);

        const rankIndex = appCache.rankedLeaderboard.findIndex(u => u.username === username);
        const modalRankEl = document.getElementById('modalUserRank');

        if (user.isDisqualified) {
            modalRankEl.innerHTML = getStyledRankHTML(null);
            modalRankEl.innerHTML += '<div class="text-xs text-red-500 mt-1">Uslov min. 10 tiketa u Sezoni nije ispunjen!</div>';
        } else {
            const rank = rankIndex !== -1 ? rankIndex + 1 : null;
            modalRankEl.innerHTML = getStyledRankHTML(rank);
        }

        document.getElementById('modalUserInfo').innerHTML =
            `<div><strong>Pridružio se:</strong><span class="font-medium text-zinc-300 text-right">${formatDate(user.joinDate)}</span></div>
            <div><strong>Država:</strong><span class="font-medium text-zinc-300 text-right">${user.country}</span></div>
            <div><strong>Poslednja aktivnost:</strong><span class="font-medium text-zinc-300 text-right">${formatDate(user.PoslednjaAktivnost, true)}</span></div>
            <div><strong>Takmiči se od:</strong><span class="font-medium text-zinc-300 text-right">${(user.StartSezona || 'N/A')}</span></div>`;

        const totalBets = user.correctBets + user.incorrectBets + user.pushVoidBets;
        document.getElementById('modalPlayerStats').innerHTML =
            `<div><strong>Ukupno tiketa:</strong><span class="font-medium text-blue-400">${totalBets}</span></div>
            <div><strong>Ukupno uloženo:</strong><span class="font-medium text-zinc-300 flex items-center justify-end">${parseFloat(user.totalStaked).toFixed(2)} ${createCoinImg()}</span></div>
            <div><strong>Najduži niz dobitnih:</strong><span class="font-medium text-emerald-400">${user.winStreak}</span></div>
            <div><strong>Najduži niz gubitnih:</strong><span class="font-medium text-rose-400">${user.lossStreak}</span></div>`;

        const outcomesContainer = document.getElementById('bettingOutcomesCircles');
        const userTickets = appCache.tickets.filter(t => t.KorisnikID === user.KorisnikID);
        const finishedTickets = userTickets.filter(t => t.Status !== 'Aktivan').sort((a, b) => new Date(b.Datum) - new Date(a.Datum));

        outcomesContainer.innerHTML = '';
        if (finishedTickets.length === 0) {
            outcomesContainer.innerHTML = '<p class="text-zinc-500 text-sm">Nema završenih tiketa.</p>';
        } else {
            finishedTickets.forEach(ticket => {
                let outcomeChar, outcomeClassSuffix;
                // ISPRAVKA POČINJE OVDE
                if (ticket.Status === 'Dobitan') {
                    outcomeChar = 'D';
                    outcomeClassSuffix = 'D';
                } else if (ticket.Status === 'Gubitan') {
                    outcomeChar = 'G';
                    outcomeClassSuffix = 'G';
                } else {
                    outcomeChar = 'P';
                    outcomeClassSuffix = 'P';
                }
                // ISPRAVKA SE ZAVRŠAVA OVDE

                const square = document.createElement('div');
                square.className = `outcome-square outcome-${outcomeClassSuffix}`;
                square.textContent = outcomeChar;
                square.dataset.ticketData = JSON.stringify(ticket);

               if (window.innerWidth < 1024) {
    square.addEventListener('click', (e) => {
        e.stopPropagation();
        showCentralPopover(e);
        const popover = document.getElementById('centralTicketPopover');

        const clickOutsideHandler = (event) => {
            if (!popover.contains(event.target) && !square.contains(event.target)) {
                hideCentralPopover();
                document.removeEventListener('click', clickOutsideHandler);
            }
        };
        setTimeout(() => document.addEventListener('click', clickOutsideHandler), 0);
    });
} else {
    square.addEventListener('mouseenter', showCentralPopover);
    square.addEventListener('mouseleave', hideCentralPopover);
}

outcomesContainer.appendChild(square);
            });
        }
        
        // Prikaz SVIH trofeja u profilu korisnika
        const seasonalTrophies = user.seasonalTrophies || [];
        const permanentTrophies = user.StalniTrofeji || [];
        const allTrophies = [...permanentTrophies, ...seasonalTrophies];
        renderTrophies(allTrophies, document.getElementById('modalUserTrophies'));

        openModal(userHistoryModal);
        lucide.createIcons();
    }

    function showMyTickets() {
        if (!currentUser || !appCache.isDataLoaded) return;
        const myTickets = appCache.tickets.filter(t => t.KorisnikID === currentUser.KorisnikID) || [];
        const sortedTickets = myTickets.sort((a, b) => new Date(b.Datum) - new Date(a.Datum));
        
        renderMyTickets(sortedTickets);
        openModal(myTicketsModal);
    }
    
    function renderMyTickets(tickets) {
        const listContainer = document.getElementById('myTicketsList');
        listContainer.innerHTML = tickets.length === 0 ? '<p class="text-center p-4">Nemate odigranih tiketa.</p>' : '';

        const groupedByDate = tickets.reduce((acc, ticket) => {
            const date = formatDate(ticket.Datum);
            if (!acc[date]) acc[date] = [];
            acc[date].push(ticket);
            return acc;
        }, {});

        Object.keys(groupedByDate).forEach(date => {
            const dateGroupContainer = document.createElement('div');
            const header = document.createElement('div');
            header.className = 'date-group-header';
            header.innerHTML = `<span>${date}</span><i data-lucide="chevron-down" class="w-5 h-5 transition-transform"></i>`;
            
            const ticketsContainer = document.createElement('div');
            ticketsContainer.className = 'date-group-tickets space-y-3';

            header.addEventListener('click', () => {
                const icon = header.querySelector('i');
                const isVisible = ticketsContainer.style.display === 'block';
                ticketsContainer.style.display = isVisible ? 'none' : 'block';
                icon.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
            });

            groupedByDate[date].forEach(ticket => {
                const el = document.createElement('div');
                el.innerHTML = generateTicketPopoverHTML(ticket);
                ticketsContainer.appendChild(el);
            });
            
            dateGroupContainer.appendChild(header);
            dateGroupContainer.appendChild(ticketsContainer);
            listContainer.appendChild(dateGroupContainer);
        });
        lucide.createIcons();
    }

    function addTicketInputField() {
        const container = document.getElementById('ticketInputsContainer');
        const inputGroup = document.createElement('div');
        inputGroup.className = 'flex items-center gap-2 ticket-pair-row';
        inputGroup.innerHTML = `
            <input type="text" class="input-field flex-grow pair-input" placeholder="npr. PSG - Real" required oninvalid="this.setCustomValidity('Molimo Vas, unesite par.')" oninput="this.setCustomValidity('')">
            <input type="text" class="input-field w-24 tip-input" placeholder="Tip (npr. 1)" required oninvalid="this.setCustomValidity('Molimo Vas, unesite tip.')" oninput="this.setCustomValidity('')">
            <button type="button" class="text-zinc-400 hover:text-red-500 p-2" onclick="this.parentElement.remove(); lucide.createIcons();"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
        `;
        
        if (!container.querySelector('.add-pair-button')) {
             const addButtonRow = document.createElement('div');
             addButtonRow.className = 'flex justify-end';
             addButtonRow.innerHTML = '<button type="button" class="add-pair-button mt-2 text-sky-400 hover:text-sky-300 flex items-center gap-1 text-sm font-semibold" onclick="addTicketInputField()"><i data-lucide="plus-circle" class="w-4 h-4"></i> Dodaj par</button>';
             container.appendChild(addButtonRow);
        }
        
        container.insertBefore(inputGroup, container.lastChild);
        lucide.createIcons();
    }

    async function handleAddTicket(e) {
        e.preventDefault();
        const btn = e.target.querySelector('#submitTicket');
        const originalText = btn.innerHTML;
        
        const pairs = [];
        const tips = [];
        document.querySelectorAll('#ticketInputsContainer .ticket-pair-row').forEach(row => {
            const pairInput = row.querySelector('.pair-input');
            const tipInput = row.querySelector('.tip-input');
            if (pairInput && tipInput && pairInput.value.trim() !== '' && tipInput.value.trim() !== '') {
                pairs.push(pairInput.value.trim());
                tips.push(tipInput.value.trim());
            }
        });

        const stake = parseFloat(stakeInput.value);

        if (pairs.length === 0) {
            showToast('Morate uneti bar jedan par i tip.', 'error');
            return;
        }
        if (!stake) {
            showToast('Morate uneti ulog.', 'error');
            return;
        }
        if (stake < MIN_STAKE) {
            showToast(`Minimalni ulog po tiketu je ${MIN_STAKE}.`, 'error');
            stakeError.innerHTML = `Minimalni ulog po tiketu je ${MIN_STAKE} ${createCoinImg()}`;
            lucide.createIcons();
            return;
        }
        const dailyRemaining = DAILY_POINT_LIMIT - getCurrentDailyPointsUsed();
        if (stake > dailyRemaining) {
            showToast(`Ulog je veći od preostalih dnevnih poena (${dailyRemaining}).`, 'error');
            stakeError.innerHTML = `Maksimalni dnevni ulog je ${dailyRemaining} ${createCoinImg()}`;
            lucide.createIcons();
            return;
        }
        if (stake > parseFloat(currentUser.UkupnoPoena)) {
            showToast(`Nemate dovoljno ukupnih poena. Stanje: ${parseFloat(currentUser.UkupnoPoena).toFixed(2)}`, 'error');
            stakeError.innerHTML = `Nemate dovoljno poena. Stanje: ${parseFloat(currentUser.UkupnoPoena).toFixed(2)} ${createCoinImg()}`;
            lucide.createIcons();
            return;
        }
        
        btn.disabled = true; btn.innerHTML = 'Slanje...';

        try {
            const result = await callGAS('addTicket', { 
                username: currentUser.KorisnickoIme, 
                pairs, 
                tips,
                stake
            });
            
            currentUser.DnevnoPotroseno = result.user.dailyPointsUsed;
            currentUser.PoslednjiReset = result.user.lastDailyReset;
            currentUser.UkupnoPoena -= stake;
            localStorage.setItem('kockariUser', JSON.stringify(currentUser));

            updateAuthUI(true);
            closeModal(document.getElementById('addTicketModal'));
            showToast('Tiket je uspešno dodat!', 'success');
            e.target.reset();
            stakeError.innerHTML = '';
            
            await fetchAndCacheAllData();

        } catch (error) {
            console.error("Dodavanje tiketa nije uspelo:", error);
        } finally {
            btn.disabled = false; btn.innerHTML = originalText;
        }
    }

    function showMyProfile() {
        if (!currentUser || !appCache.isDataLoaded) return;

        const userImage = getUserDisplayImage(currentUser);
        profileModalPic.src = userImage;

        const removeOption = document.getElementById('removePhotoOption');
        if (userImage !== getCountryImage(currentUser.Drzava)) {
            removeOption.classList.remove('hidden');
        } else {
            removeOption.classList.add('hidden');
        }
        profilePicMenu.classList.add('hidden'); // Ensure menu is hidden on modal open

        profileModalUsername.textContent = currentUser.KorisnickoIme;
        profileModalJoinDate.textContent = formatDate(currentUser.DatumRegistracije);
        profileModalCountry.textContent = currentUser.Drzava || 'N/A';

        const rankIndex = appCache.rankedLeaderboard.findIndex(u => u.username === currentUser.KorisnickoIme);
        const profileRankEl = document.getElementById('profileModalRank');

        if (currentUser.isDisqualified) {
            profileRankEl.innerHTML = getStyledRankHTML(null);
        } else {
            const rank = rankIndex !== -1 ? rankIndex + 1 : null;
            profileRankEl.innerHTML = getStyledRankHTML(rank);
        }
        
        lucide.createIcons();
        openModal(myProfileModal);
    }
    
    async function showAchievements() {
        if (!currentUser || !appCache.isDataLoaded) {
            showToast('Morate biti prijavljeni da biste videli dostignuća.', 'error');
            return;
        }
        
        openModal(achievementsModal);
        
        await fetchHistoryData();

        const userHistorySeasons = [...new Set(appCache.history
            .filter(h => h.KorisnikID === currentUser.KorisnikID)
            .map(h => parseInt(h.Sezona)))];
            
        const allParticipatedSeasons = [...new Set([...userHistorySeasons, currentSeasonInfo.season])].sort((a, b) => b - a);
        
        renderSeasonSelector(allParticipatedSeasons, currentSeasonInfo.season);
        renderAchievementsForSeason(currentSeasonInfo.season);
    }

    function renderSeasonSelector(seasons, activeSeason) {
        const container = document.getElementById('achievementsSeasonSelectorContainer');
        container.innerHTML = ''; // Clear previous content

        if (seasons.length === 0) {
            container.innerHTML = `<p class="text-zinc-400">Nema podataka o sezonama.</p>`;
            return;
        }

        const selectorContainer = document.createElement('div');
        selectorContainer.className = 'season-selector-container';

        const button = document.createElement('button');
        button.className = 'season-selector-button';
        button.innerHTML = `<span>Sezona ${activeSeason}</span><i data-lucide="chevron-down" class="chevron w-5 h-5"></i>`;
        if (activeSeason === currentSeasonInfo.season) {
            button.classList.add('current-season');
        }

        const dropdown = document.createElement('div');
        dropdown.className = 'season-selector-dropdown';

        seasons.forEach(season => {
            const item = document.createElement('div');
            item.className = 'season-selector-item';
            item.textContent = `Sezona ${season}`;
            item.dataset.season = season;
            if (season === activeSeason) {
                item.classList.add('selected');
            }
            item.addEventListener('click', () => {
                renderAchievementsForSeason(season);
                dropdown.classList.remove('show');
                button.querySelector('span').textContent = `Sezona ${season}`;
                button.classList.toggle('current-season', season === currentSeasonInfo.season);
                button.querySelector('.chevron').style.transform = 'rotate(0deg)';
            });
            dropdown.appendChild(item);
        });
        
        selectorContainer.appendChild(button);
        selectorContainer.appendChild(dropdown);
        container.appendChild(selectorContainer);
        
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdown.classList.toggle('show');
            button.querySelector('.chevron').style.transform = dropdown.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
        });
        
        document.addEventListener('click', (e) => {
             if (!selectorContainer.contains(e.target)) {
                 dropdown.classList.remove('show');
                 button.querySelector('.chevron').style.transform = 'rotate(0deg)';
             }
        });

        lucide.createIcons();
    }

    function renderAchievementsForSeason(season) {
    document.querySelectorAll('.season-selector-item').forEach(item => {
        item.classList.toggle('selected', parseInt(item.dataset.season) === season);
    });

    let stats = {};
    let bestTicket = null;
    let trophiesForSeason = [];

    // --- ISPRAVKA: Robustniji način za pronalaženje podataka o korisniku ---
    // Prvo pokušavamo da nađemo korisnika u glavnoj tabeli.
    let userForAchievements = appCache.leaderboard.find(u => u.KorisnikID === currentUser.KorisnikID);

    // Ako ga ne nađemo (npr. potpuno nov korisnik), koristimo globalni 'currentUser' objekat
    // kao rezervu, jer on uvek sadrži sveže podatke.
    if (!userForAchievements) {
        userForAchievements = currentUser;
    }
    // --- KRAJ ISPRAVKE ---

    const permanentTrophies = userForAchievements ? (userForAchievements.StalniTrofeji || []) : [];

    // Početak filtera za stalne trofeje
    let kingEarnedSeason = null;
    const championSeasons = permanentTrophies
        .map(t => {
            const match = t.match(/Šampion Sezone (\d+)/);
            return match ? parseInt(match[1]) : null;
        })
        .filter(s => s !== null)
        .sort((a, b) => a - b);

    if (championSeasons.length >= 3) {
        kingEarnedSeason = championSeasons[2];
    }

    const filteredPermanentTrophies = permanentTrophies.filter(trophy => {
        const seasonMatch = trophy.match(/Sezone (\d+)/);
        if (seasonMatch) {
            const earnedSeason = parseInt(seasonMatch[1]);
            return season >= earnedSeason;
        }
        if (trophy === 'Kralj kladionice') {
            return kingEarnedSeason !== null && season >= kingEarnedSeason;
        }
        return true; // Vraćeno na 'true' da bi bilo bezbednije
    });
    // Kraj filtera

    if (season === currentSeasonInfo.season) {
        const userStats = userForAchievements; // Koristimo novu, bezbedniju promenljivu
        if (!userStats || !userStats.KorisnikID) { // Dodata provera
            displayEmptyAchievements();
            // Prikazujemo stalne trofeje čak i ako nema statistike
            renderTrophies(filteredPermanentTrophies, document.getElementById('achievementsTrophiesContainer'));
            return;
        }

        const rankIndex = appCache.rankedLeaderboard.findIndex(u => u.KorisnikID === userStats.KorisnikID);

        stats.plasman = userStats.isDisqualified ? null : (rankIndex !== -1 ? rankIndex + 1 : null);
        stats.isDisqualified = userStats.isDisqualified;
        stats.profit = parseFloat(userStats.netProfitLoss || 0);
        stats.roi = parseFloat((userStats.roi || '0%').replace('%', ''));
        stats.nizDobitnih = userStats.winStreak || 0;
        stats.nizGubitnih = userStats.lossStreak || 0;

        const seasonalTrophies = userStats.seasonalTrophies || [];
        trophiesForSeason = [...filteredPermanentTrophies, ...seasonalTrophies];

        const userTickets = appCache.tickets.filter(t => t.KorisnikID === userStats.KorisnikID && t.Status === 'Dobitan');
        let maxProfit = -Infinity;
        userTickets.forEach(ticket => {
            const profit = (parseFloat(ticket.Ulog) * parseFloat(ticket.Kvota)) - parseFloat(ticket.Ulog);
            if (profit > maxProfit) {
                maxProfit = profit;
                bestTicket = ticket;
            }
        });
        stats.profitNajboljegTiketa = maxProfit > -Infinity ? maxProfit : 0;

    } else {
        // Logika za prethodne sezone (ostaje ista)
        const historyData = appCache.history.find(h => h.KorisnikID === currentUser.KorisnikID && parseInt(h.Sezona) === season);
        if (!historyData) {
            displayEmptyAchievements();
            renderTrophies(filteredPermanentTrophies, document.getElementById('achievementsTrophiesContainer'));
            return;
        }
        
        try {
            stats.plasman = (historyData.Plasman && parseInt(historyData.Plasman) > 0) ? parseInt(historyData.Plasman) : null;
            stats.isDisqualified = !stats.plasman;
            stats.profit = parseFloat(historyData.Profit || 0);
            stats.nizDobitnih = parseInt(historyData.NajduziNizDobitnih || 0);
            stats.nizGubitnih = parseInt(historyData.NajduziNizGubitnih || 0);
            stats.profitNajboljegTiketa = parseFloat(historyData.ProfitNajboljegTiketa || 0);
            
            let roiFromHistory = historyData.ROI || 0;
            if (String(roiFromHistory).includes('%')) {
                stats.roi = parseFloat(String(roiFromHistory).replace('%', ''));
            } else {
                stats.roi = parseFloat(roiFromHistory) * 100;
            }
            
            let seasonalTrophies = [];
            if (historyData.Trofeji) {
                try {
                    seasonalTrophies = JSON.parse(historyData.Trofeji);
                    if (!Array.isArray(seasonalTrophies)) seasonalTrophies = [];
                } catch(e) { seasonalTrophies = []; }
            }
            trophiesForSeason = [...filteredPermanentTrophies, ...seasonalTrophies];
            
            if (stats.profitNajboljegTiketa > 0 && historyData.ParoviNajboljegTiketa) {
                const safeJsonParse = (data) => {
                    if (!data || typeof data !== 'string') return [];
                    try {
                        const parsed = JSON.parse(data);
                        return Array.isArray(parsed) ? parsed : [];
                    } catch(e) {
                        return [];
                    }
                };
                bestTicket = {
                    Status: 'Dobitan',
                    Datum: historyData.DatumNajboljegTiketa || 'N/A',
                    Ulog: parseFloat(historyData.UlogNajboljegTiketa || 0),
                    Kvota: parseFloat(historyData.UkKvotaNajboljegTiketa || 0),
                    Parovi: historyData.ParoviNajboljegTiketa || [],
                    Tipovi: historyData.TipoviNajboljegTiketa || [],
                    Kvote: historyData.KvoteNajboljegTiketa || [],
                    Vreme: historyData.VremeNajboljegTiketa || [],
                    Rezultati: historyData.RezulatiNajboljegTiketa || [],
                    StatusParova: historyData.StatusParovaNajboljegTiketa || []
                };
            }
        } catch (error) {
            console.error(`Greška pri obradi podataka za istorijsku sezonu ${season}:`, error);
            displayEmptyAchievements();
            renderTrophies(filteredPermanentTrophies, document.getElementById('achievementsTrophiesContainer'));
            return; 
        }
    }
    
    displayAchievementStats(stats, bestTicket, trophiesForSeason);
}


    function displayEmptyAchievements() {
        const container = document.getElementById('achievementsStatsContainer');
        container.innerHTML = '<div class="bg-zinc-800/50 p-4 rounded-lg border border-zinc-700 text-center text-zinc-400">Nema podataka za izabranu sezonu.</div>';
        renderTrophies([], document.getElementById('achievementsTrophiesContainer'));
    }

    function displayAchievementStats(stats, ticket, trophyIds = []) {
    const container = document.getElementById('achievementsStatsContainer');
    const profitClass = stats.profit > 0 ? 'profit-positive' : stats.profit < 0 ? 'profit-negative' : 'profit-neutral';
    const roiClass = stats.roi > 0 ? 'profit-positive' : stats.roi < 0 ? 'profit-negative' : 'profit-neutral';
    const bestTicketProfitClass = stats.profitNajboljegTiketa > 0 ? 'profit-positive' : 'profit-neutral';

    const plasmanText = stats.plasman ? `#${stats.plasman}` : 'Nije rangiran';
    const plasmanColor = stats.plasman ? 'text-amber-400' : 'text-zinc-500';

    container.innerHTML = 
        `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="bg-zinc-800/50 p-3 rounded-lg border border-zinc-700 text-center">
                <p class="achievement-label">Plasman</p>
                <p class="achievement-value ${plasmanColor}">${plasmanText}</p>
                ${stats.isDisqualified ? '<p class="text-xs text-red-500 mt-1">Uslov min. 10 tiketa u Sezoni nije ispunjen!</p>' : ''}
            </div>
            <div class="bg-zinc-800/50 p-3 rounded-lg border border-zinc-700 text-center">
                <p class="achievement-label">Profit</p>
                <p class="achievement-value ${profitClass} flex items-center justify-center">${(stats.profit > 0 ? '+' : '')}${stats.profit.toFixed(2)} ${createCoinImg()}</p>
            </div>
            <div class="bg-zinc-800/50 p-3 rounded-lg border border-zinc-700 text-center">
                <p class="achievement-label">ROI</p>
                <p class="achievement-value ${roiClass}">${(stats.roi > 0 ? '+' : '')}${stats.roi.toFixed(2)}%</p>
            </div>
            <div id="bestTicketStat" class="bg-zinc-800/50 p-3 rounded-lg border border-zinc-700 text-center ${ticket ? 'cursor-pointer' : ''}">
                <p class="achievement-label">Najbolji tiket</p>
                <p class="achievement-value ${bestTicketProfitClass} flex items-center justify-center">${(ticket ? '+' + stats.profitNajboljegTiketa.toFixed(2) : '0.00')} ${createCoinImg()}</p>
            </div>
            <div class="bg-zinc-800/50 p-3 rounded-lg border border-zinc-700 text-center">
                <p class="achievement-label">Najduži niz dobitnih</p>
                <p id="achievementsWinStreak" class="achievement-value text-green-400">${stats.nizDobitnih}</p>
            </div>
             <div class="bg-zinc-800/50 p-3 rounded-lg border border-zinc-700 text-center">
                <p class="achievement-label">Najduži niz gubitnih</p>
                <p id="achievementsLossStreak" class="achievement-value text-red-400">${stats.nizGubitnih}</p>
            </div>
        </div>`;
    
    const bestTicketElement = document.getElementById('bestTicketStat');
    if (ticket && bestTicketElement) {
        bestTicketElement.addEventListener('mouseenter', (event) => showBestTicketPopover(event, ticket));
        bestTicketElement.addEventListener('mouseleave', hideBestTicketPopover);
    }

    renderTrophies(trophyIds, document.getElementById('achievementsTrophiesContainer'));
    lucide.createIcons();
}

    function showBestTicketPopover(event, ticket) {
        const popover = document.getElementById('bestTicketPopover');
        popover.innerHTML = generateTicketPopoverHTML(ticket);
        lucide.createIcons();

        const modalContent = achievementsModal.querySelector('.content-overlay');
        
        popover.style.visibility = 'hidden';
        popover.classList.add('show');
        
        const modalRect = modalContent.getBoundingClientRect();
        const popoverRect = popover.getBoundingClientRect();

        const top = (modalRect.height - popoverRect.height) / 2;
        const left = (modalRect.width - popoverRect.width) / 2;
        
        popover.style.top = `${top}px`;
        popover.style.left = `${left}px`;
        
        popover.style.visibility = 'visible';
    }

    function hideBestTicketPopover() {
        document.getElementById('bestTicketPopover').classList.remove('show');
    }


    function showSettings() {
        if (!currentUser) return;
        
        const isChangeAllowed = currentSeasonInfo.isOffSeason;
        const infoColor = isChangeAllowed ? '' : '#ef4444';

        ['Email'].forEach(type => {
            const form = document.getElementById(`change${type}Form`);
            form.reset();
            form.querySelector('input').disabled = !isChangeAllowed;
            form.querySelector('button').disabled = !isChangeAllowed;
        const infoElement = document.getElementById(`${type.toLowerCase()}ChangeInfo`);
            if (infoElement) {
                infoElement.style.color = infoColor;
            }
            document.getElementById(`${type.toLowerCase()}ChangeInfo`).style.color = infoColor;
        });
        document.getElementById('changePasswordForm').reset();
        openModal(settingsModal);
    }
    
    function handleLeaderboardSearch(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        document.querySelectorAll('#leaderboard-container-desktop tbody tr').forEach(row => {
            const username = row.dataset.username;
            if (username) {
                const isVisible = username.includes(searchTerm);
                row.style.display = isVisible ? '' : 'none';
                row.classList.toggle('highlighted', isVisible && searchTerm.length > 0);
            }
        });
    }

    // --- POMOĆNE FUNKCIJE ---
    function togglePasswordVisibility(inputId, icon) {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
            input.type = 'text';
            icon.dataset.lucide = 'eye-off';
        } else {
            input.type = 'password';
            icon.dataset.lucide = 'eye';
        }
        lucide.createIcons();
    }

    function openModal(modal) { if(modal) { modal.classList.add('show'); lucide.createIcons(); } }
    function closeModal(modal) { if (modal) modal.classList.remove('show'); }
    
    function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;

    const icons = { success: 'check-circle-2', error: 'shield-alert', info: 'info' };
    const titles = { success: 'Uspeh!', error: 'Greška!', info: 'Informacija' };

    // Nova HTML struktura koja uključuje progress bar
    toast.innerHTML = `
        <div class="toast-icon">
            <i data-lucide="${icons[type]}"></i>
        </div>
        <div class="toast-content">
            <p class="toast-title">${titles[type]}</p>
            <p class="toast-message">${message}</p>
        </div>
        <button class="toast-close-btn">
            <i data-lucide="x" class="w-4 h-4"></i>
        </button>
        <div class="toast-progress"></div>
    `;

    container.appendChild(toast);
    lucide.createIcons();

    const closeToast = () => {
        // Sprečavamo ponovno pokretanje animacije ako je već u toku
        if (toast.classList.contains('closing')) return;
        
        toast.classList.add('closing');
        toast.addEventListener('animationend', () => {
            if (toast) toast.remove();
        });
    };

    const timer = setTimeout(closeToast, 2000); // 2 sekunde

    toast.querySelector('.toast-close-btn').addEventListener('click', () => {
        clearTimeout(timer);
        closeToast();
    });
}
    
    // --- FUNKCIJE ZA PROMENU PROFILNE SLIKE ---

    function resizeImage(file, maxWidth, maxHeight) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.9));
                };
                img.onerror = reject;
            };
            reader.onerror = reject;
        });
    }

    async function handleProfilePictureSelect(event) {
        const file = event.target.files[0];
        if (!file || !currentUser) return;

        showToast('Slanje slike...', 'info');
        
        try {
            const resizedBase64 = await resizeImage(file, 200, 200);
            
            const result = await callGAS('updateProfilePicture', {
                userId: currentUser.KorisnikID,
                base64Image: resizedBase64
            });

            const newImageUrl = result.imageUrl;

            currentUser.ProfilnaSlika = newImageUrl;
            localStorage.setItem('kockariUser', JSON.stringify(currentUser));
             const userIndexInCache = appCache.users.findIndex(u => u.KorisnikID === currentUser.KorisnikID);
            if (userIndexInCache > -1) {
                appCache.users[userIndexInCache].ProfilnaSlika = newImageUrl;
            }

            const userIndexInLeaderboard = appCache.leaderboard.findIndex(u => u.KorisnikID === currentUser.KorisnikID);
            if (userIndexInLeaderboard > -1) {
                appCache.leaderboard[userIndexInLeaderboard].ProfilnaSlika = newImageUrl;
            }
            document.querySelectorAll('#profilePic, #profileModalPic, #mobileProfileButton img').forEach(img => {
                if (img) img.src = newImageUrl;
            });
            document.getElementById('removePhotoOption').classList.remove('hidden');

            showToast('Profilna slika je uspešno promenjena!', 'success');

        } catch (error) {
            console.error("Greška pri promeni slike:", error);
            showToast('Došlo je do greške pri promeni slike.', 'error');
        } finally {
            event.target.value = '';
        }
    }

    async function handleRemoveProfilePicture() {
        if (!currentUser) return;

        showConfirmation(
            "Brisanje slike",
            "Da li ste sigurni da želite da obrišete profilnu sliku?",
            async () => {
                showToast('Brisanje slike...', 'info');
                try {
                    await callGAS('removeProfilePicture', { userId: currentUser.KorisnikID });

                    delete currentUser.ProfilnaSlika;
                    localStorage.setItem('kockariUser', JSON.stringify(currentUser));

                    const userIndexInCache = appCache.users.findIndex(u => u.KorisnikID === currentUser.KorisnikID);
                    if (userIndexInCache > -1) {
                        delete appCache.users[userIndexInCache].ProfilnaSlika;
                    }
                    const userIndexInLeaderboard = appCache.leaderboard.findIndex(u => u.KorisnikID === currentUser.KorisnikID);
                    if (userIndexInLeaderboard > -1) {
                        delete appCache.leaderboard[userIndexInLeaderboard].ProfilnaSlika;
                    }

                    const defaultImage = getCountryImage(currentUser.Drzava);
                    document.querySelectorAll('#profilePic, #profileModalPic, #mobileProfileButton img').forEach(img => {
                        if (img) img.src = defaultImage;
                    });
                    document.getElementById('removePhotoOption').classList.add('hidden');

                    showToast('Profilna slika je obrisana.', 'success');
                } catch (error) {
                    console.error("Greška pri brisanju slike:", error);
                    showToast('Došlo je do greške pri brisanju slike.', 'error');
                }
            }
        );
    }
</script>
<script>
    // --- ADMINISTRATORSKE FUNKCIJE ---

    // Poziva se kada se otvori Settings modal da proveri da li treba prikazati admin sekciju
    function checkAndShowAdminControls() {
        const adminSection = document.getElementById('adminSection');
        if (currentUser && appCache.settings && currentUser.Email === appCache.settings.adminEmail) {
            adminSection.classList.remove('hidden');
        } else {
            adminSection.classList.add('hidden');
        }
    }

    // Dodajte event listener za novo dugme
    document.addEventListener('DOMContentLoaded', () => {
        const archiveBtn = document.getElementById('archiveSeasonButton');
        if(archiveBtn) {
            archiveBtn.addEventListener('click', handleArchiveSeason);
        }
        
        // Modifikujte listener za settings dugme da pozove i proveru za admina
        const settingsBtn = document.getElementById('profileModalSettingsButton');
        if(settingsBtn) {
            settingsBtn.addEventListener('click', () => {
                closeModal(myProfileModal);
                showSettings();
                checkAndShowAdminControls(); // Poziv nove funkcije
            });
        }
    });

    // Glavna funkcija koja se poziva klikom na dugme
    function handleArchiveSeason() {
        if (!currentUser || currentUser.Email !== appCache.settings.adminEmail) {
            showToast('Niste ovlašćeni za ovu akciju.', 'error');
            return;
        }

        showConfirmation(
            "Arhiviranje Sezone",
            `Da li ste sigurni da želite da arhivirate podatke za Sezonu ${currentSeasonInfo.season}? Ovaj proces se ne može opozvati.`,
            async () => {
                showToast('Počinje arhiviranje sezone...', 'info');
                
                // Koristimo već izračunate podatke iz `appCache.leaderboard`
                const usersToArchive = appCache.leaderboard;
                const seasonToArchive = currentSeasonInfo.season;
                const MIN_TICKETS_FOR_RANKING = 10;

                for (const user of usersToArchive) {
                    // Pronalazimo najbolji tiket za korisnika
                    const userTickets = appCache.tickets.filter(t => t.KorisnikID === user.KorisnikID && t.Status === 'Dobitan');
                    let bestTicket = null;
                    let maxProfit = -Infinity;
                    userTickets.forEach(ticket => {
                        const profit = (parseFloat(ticket.Ulog) * parseFloat(ticket.Kvota)) - parseFloat(ticket.Ulog);
                        if (profit > maxProfit) {
                            maxProfit = profit;
                            bestTicket = ticket;
                        }
                    });

                    const finishedTicketCount = user.correctBets + user.incorrectBets;
                    const isRanked = finishedTicketCount >= MIN_TICKETS_FOR_RANKING;
                    const rankIndex = appCache.rankedLeaderboard.findIndex(u => u.KorisnikID === user.KorisnikID);

                    // Pripremamo payload sa podacima koje šaljemo skripti
                    const payload = {
                        Sezona: seasonToArchive,
                        KorisnikID: user.KorisnikID,
                        KorisnickoIme: user.username,
                        Plasman: isRanked && rankIndex !== -1 ? rankIndex + 1 : 0, // 0 ako nije rangiran
                        Profit: user.netProfitLoss,
                        ROI: user.roi,
                        DatumNajboljegTiketa: bestTicket ? bestTicket.Datum : null,
                        ParoviNajboljegTiketa: bestTicket ? JSON.stringify(bestTicket.Parovi) : null,
                        TipoviNajboljegTiketa: bestTicket ? JSON.stringify(bestTicket.Tipovi) : null,
                        UlogNajboljegTiketa: bestTicket ? bestTicket.Ulog : 0,
                        ProfitNajboljegTiketa: bestTicket ? maxProfit : 0,
                        KvoteNajboljegTiketa: bestTicket ? JSON.stringify(bestTicket.Kvote) : null,
                        UkKvotaNajboljegTiketa: bestTicket ? bestTicket.Kvota : 0,
                        VremeNajboljegTiketa: bestTicket ? JSON.stringify(bestTicket.Vreme) : null,
                        StatusParovaNajboljegTiketa: bestTicket ? JSON.stringify(bestTicket.StatusParova) : null,
                        RezulatiNajboljegTiketa: bestTicket ? JSON.stringify(bestTicket.Rezultati) : null,
                        NajduziNizDobitnih: user.winStreak,
                        NajduziNizGubitnih: user.lossStreak,
                        Trofeji: JSON.stringify(user.seasonalTrophies || [])
                    };

                    try {
                        // Šaljemo podatke za svakog korisnika ponaosob
                        await callGAS('addSeasonHistory', payload);
                        console.log(`Arhiviran korisnik: ${user.username}`);
                    } catch (error) {
                        showToast(`Greška pri arhiviranju korisnika ${user.username}: ${error.message}`, 'error');
                        // Prekidamo proces ako dođe do greške
                        return;
                    }
                }
                
                showToast(`Sezona ${seasonToArchive} je uspešno arhivirana za sve korisnike!`, 'success');
                // Osvežavamo keš sa istorijom
                appCache.isHistoryLoaded = false;
                await fetchHistoryData();
            }
        );
    }
</script>
</body>
</html>
